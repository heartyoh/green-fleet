/*9eb06f43c463961ffaae03bcee2af748fc8fc85e*/Ext.define("HatioBB.mixin.User",function(){return{login:{key:login.key,email:login.email,id:login.username,name:login.username,language:login.language}}}());Ext.define("HatioBB.mixin.SubItem",function(){Ext.Container.implement({sub:function(a){if(!this.subitems){this.subitems={}}if(!this.subitems[a]){this.subitems[a]=this.down("[itemId="+a+"]")}return this.subitems[a]}});return{}}());Ext.define("HatioBB.mixin.Setting",function(){var d=[{id:"autofit",value:false},{id:"refreshTerm",value:-1},{id:"dockPosition",value:"right"},{id:"auto_max_zoom",value:16}];Ext.define("HatioBB.mixin.Setting.Model",{extend:"Ext.data.Model",config:{fields:[{name:"id",type:"string"},{name:"value",type:"auto"}],proxy:{type:"localstorage",id:"hatiobb-settings"}}});var c=Ext.create("Ext.data.Store",{model:"HatioBB.mixin.Setting.Model",autoSync:true});function b(g){var e=c.getById(g);if(e){return e.get("value")}else{return null}}function a(h,i){var g=c.getById(h);var e;if(!g){var j=Ext.create("HatioBB.mixin.Setting.Model",{id:h,value:undefined});c.add(j);g=c.getById(h)}g.set("value",i);g.commit();return e}Ext.define("HatioBB.mixin.Setting.Inner",{mixins:["Ext.mixin.Observable"],set:function(h,g){var e=a(h,g);this.fireEvent(h,g,e)},get:function(e){return b(e)}});c.on("load",function(g,e){for(var h=0;h<d.length;h++){if(!g.getById(d[h].id)){a(d[h].id,d[h].value)}}});try{c.load()}catch(f){c.getProxy().clear();c.load()}return{setting:Ext.create("HatioBB.mixin.Setting.Inner")}}());Ext.define("HatioBB.view.Setting",{extend:"Ext.form.Panel",xtype:"setting",constructor:function(a){a.items=this.buildItems();this.callParent(arguments);this.on("erased",function(){this.destroy()})},buildItems:function(){var b=[{xtype:"fieldset",title:"System Setting",items:[{xtype:"toolbar",title:T("label.setting"),docked:"top"},{xtype:"togglefield",label:T("label.autofit"),name:"autofit",value:HatioBB.setting.get("autofit"),listeners:{change:function(e,c,d){HatioBB.setting.set(e.getName(),!!d)}}},{xtype:"selectfield",label:T("label.refreshterm"),name:"refreshTerm",valueField:"value",displayField:"display",value:HatioBB.setting.get("refreshTerm"),listeners:{change:function(d,c){HatioBB.setting.set(d.getName(),c)}},store:{data:[{value:-1,display:T("label.refresh_none")},{value:3,display:"3"+T("label.second_s")},{value:5,display:"5"+T("label.second_s")},{value:10,display:"10"+T("label.second_s")},{value:30,display:"30"+T("label.second_s")},{value:60,display:"1"+T("label.minute_s")},{value:300,display:"5"+T("label.minute_s")}]}},{xtype:"selectfield",label:T("label.dockPosition"),name:"dockPosition",valueField:"value",displayField:"display",value:HatioBB.setting.get("dockPosition"),listeners:{change:function(d,c){HatioBB.setting.set(d.getName(),c)}},store:{data:[{value:"left",display:T("label.left")},{value:"right",display:T("label.right")}]}}]}];var a=this.buildByScreen();if(a){b.push(a)}b.push(this.buildInformation());return b},buildByScreen:function(){var a=Ext.getCmp("content");var b=[];while(a&&typeof(a.getActiveItem)==="function"){a=a.getActiveItem();if(!a){break}if(a.buildSettings&&typeof(a.buildSettings)==="function"){b=Ext.Array.merge(b,a.buildSettings())}}if(b.length){return{xtype:"fieldset",title:"By Screen",items:b}}else{return null}},buildInformation:function(){return{xtype:"fieldset",title:"System Information",items:[{xtype:"textfield",label:T("label.version"),value:HatioBB.setting.get("version"),disabled:true},{xtype:"textfield",label:T("label.user"),value:HatioBB.login.id,disabled:true}]}},config:{left:0,top:0,modal:true,showAnimation:"fadeIn",hideOnMaskTap:true,hideAnimation:"fadeOut",width:400,height:500,scrollable:true}});Ext.define("HatioBB.store.VehicleFilteredStore",{extend:"Ext.data.Store",config:{autoLoad:false,pageSize:1000,fields:[{name:"id",type:"string"},{name:"registration_number",type:"string"},{name:"status",type:"string"},{name:"driver_id",type:"string"},{name:"lat",type:"float"},{name:"lng",type:"float"},{name:"location",type:"string"}]}});Ext.define("HatioBB.store.VehicleStore",{extend:"Ext.data.Store",config:{autoLoad:false,remoteFilter:true,pageSize:1,fields:[{name:"key",type:"string"},{name:"id",type:"string"},{name:"registration_number",type:"string"},{name:"manufacturer",type:"string"},{name:"fuel_type",type:"string"},{name:"vehicle_type",type:"string"},{name:"birth_year",type:"int"},{name:"ownership_type",type:"string"},{name:"status",type:"string"},{name:"health_status",type:"string"},{name:"image_clip",type:"string"},{name:"total_distance",type:"float"},{name:"remaining_fuel",type:"float"},{name:"lat",type:"float"},{name:"driver_id",type:"string"},{name:"terminal_id",type:"string"},{name:"lng",type:"float"},{name:"location",type:"string"},{name:"created_at",type:"date",dateFormat:"time"},{name:"updated_at",type:"date",dateFormat:"time"}],proxy:{type:"ajax",url:window.location.pathname.indexOf("/m/")===0?"/vehicle":"data/vehicle.json",reader:{type:"json",rootProperty:"items",totalProperty:"total",successProperty:"success"}}}});Ext.define("HatioBB.store.RecentIncidentStore",{extend:"Ext.data.Store",config:{autoLoad:false,remoteSort:true,pageSize:5,fields:[{name:"key",type:"string"},{name:"datetime",type:"date",dateFormat:"time"},{name:"terminal_id",type:"string"},{name:"vehicle_id",type:"string"},{name:"driver_id",type:"string"},{name:"lattitude",type:"float"},{name:"longitude",type:"float"},{name:"velocity",type:"float"},{name:"impulse_abs",type:"float"},{name:"impulse_x",type:"float"},{name:"impulse_y",type:"float"},{name:"impulse_z",type:"float"},{name:"impulse_threshold",type:"float"},{name:"obd_connected",type:"boolean"},{name:"confirm",type:"boolean"},{name:"engine_temp",type:"float"},{name:"engine_temp_threshold",type:"float"},{name:"video_clip",type:"string"},{name:"created_at",type:"date",dateFormat:"time"},{name:"updated_at",type:"date",dateFormat:"time"}],sorters:[{property:"datetime",direction:"DESC"}],proxy:{type:"ajax",url:window.location.pathname.indexOf("/m/")===0?"/incident":"data/incident.json",extraParams:{confirm:false},reader:{type:"json",rootProperty:"items",totalProperty:"total"}}}});Ext.define("HatioBB.store.VehicleMapStore",{extend:"Ext.data.Store",config:{pageSize:1000,autoLoad:false,fields:[{name:"id",type:"string"},{name:"registration_number",type:"string"},{name:"status",type:"string"},{name:"driver_id",type:"string"},{name:"lat",type:"float"},{name:"lng",type:"float"},{name:"location",type:"string"},{name:"image_clip",type:"string"}],proxy:{type:"ajax",url:window.location.pathname.indexOf("/m/")===0?"/vehicle":"data/vehicle_brief.json",extraParams:{select:["id","registration_number","status","driver_id","lat","lng","image_clip"]},reader:{type:"json",rootProperty:"items",totalProperty:"total"}},listeners:{load:function(a,b,c){if(c){Ext.getStore("VehicleFilteredStore").setData(b)}}}}});Ext.define("HatioBB.store.DriverStore",{extend:"Ext.data.Store",config:{autoLoad:false,remoteFilter:true,pageSize:1,fields:[{name:"key",type:"string"},{name:"name",type:"string"},{name:"id",type:"string"},{name:"division",type:"string"},{name:"title",type:"string"},{name:"social_id",type:"string"},{name:"phone_no_1",type:"string"},{name:"phone_no_2",type:"string"},{name:"image_clip",type:"string"},{name:"created_at",type:"date",dateFormat:"time"},{name:"updated_at",type:"date",dateFormat:"time"}],proxy:{type:"ajax",url:window.location.pathname.indexOf("/m/")===0?"/driver":"data/driver.json",reader:{type:"json",rootProperty:"items",totalProperty:"total"}}}});Ext.define("HatioBB.store.DriverBriefStore",{extend:"Ext.data.Store",config:{autoLoad:true,pageSize:1000,fields:[{name:"name",type:"string"},{name:"id",type:"string"},{name:"image_clip",type:"string"}],proxy:{type:"ajax",url:window.location.pathname.indexOf("/m/")===0?"/driver":"data/driver_brief.json",extraParams:{select:["id","name","image_clip"]},reader:{type:"json",rootProperty:"items",totalProperty:"total"}}}});Ext.define("HatioBB.store.VehicleGroupStore",{extend:"Ext.data.Store",config:{pageSize:1000,fields:[{name:"key",type:"string"},{name:"id",type:"string"},{name:"desc",type:"string"},{name:"vehicles",type:"auto"},{name:"created_at",type:"date",dateFormat:"time"},{name:"updated_at",type:"date",dateFormat:"time"}],proxy:{type:"ajax",url:window.location.pathname.indexOf("/m/")===0?"/vehicle_group":"data/vehicle_group.json",reader:{type:"json",rootProperty:"items",totalProperty:"total"}}}});Ext.define("HatioBB.store.DriverGroupStore",{extend:"Ext.data.Store",config:{autoLoad:true,pageSize:1000,fields:[{name:"key",type:"string"},{name:"id",type:"string"},{name:"desc",type:"string"},{name:"drivers",type:"auto"},{name:"created_at",type:"date",dateFormat:"time"},{name:"updated_at",type:"date",dateFormat:"time"}],proxy:{type:"ajax",url:window.location.pathname.indexOf("/m/")===0?"/driver_group":"data/driver_group.json",reader:{type:"json",rootProperty:"items",totalProperty:"total"}}}});Ext.define("HatioBB.store.TrackByVehicleStore",{extend:"Ext.data.Store",config:{autoLoad:false,fields:[{name:"key",type:"string"},{name:"vehicle_id",type:"string"},{name:"driver_id",type:"string"},{name:"lattitude",type:"number"},{name:"longitude",type:"number"},{name:"created_at",type:"date",dateFormat:"time"}],sorters:[{property:"datetime",direction:"DESC"}],proxy:{type:"ajax",url:window.location.pathname.indexOf("/m/")===0?"/track":"data/track.json",reader:{type:"json",rootProperty:"items",totalProperty:"total"}}}});Ext.define("HatioBB.store.IncidentByVehicleStore",{extend:"Ext.data.Store",config:{autoLoad:false,pageSize:25,fields:[{name:"key",type:"string"},{name:"datetime",type:"date",dateFormat:"time"},{name:"terminal_id",type:"string"},{name:"vehicle_id",type:"string"},{name:"driver_id",type:"string"},{name:"lattitude",type:"float"},{name:"longitude",type:"float"},{name:"velocity",type:"float"},{name:"impulse_abs",type:"float"},{name:"impulse_x",type:"float"},{name:"impulse_y",type:"float"},{name:"impulse_z",type:"float"},{name:"impulse_threshold",type:"float"},{name:"obd_connected",type:"boolean"},{name:"confirm",type:"boolean"},{name:"engine_temp",type:"float"},{name:"engine_temp_threshold",type:"float"},{name:"video_clip",type:"string"},{name:"created_at",type:"date",dateFormat:"time"},{name:"updated_at",type:"date",dateFormat:"time"}],sorters:[{property:"datetime",direction:"DESC"}],proxy:{type:"ajax",url:window.location.pathname.indexOf("/m/")===0?"/incident":"data/incident_by_vehicle.json",reader:{type:"json",rootProperty:"items",totalProperty:"total"}}}});Ext.define("HatioBB.store.IncidentLogStore",{extend:"Ext.data.Store",config:{autoLoad:false,pageSize:1000,fields:[{name:"key",type:"string"},{name:"incident",type:"string"},{name:"datetime",type:"date",dateFormat:"time"},{name:"terminal_id",type:"string"},{name:"vehicle_id",type:"string"},{name:"driver_id",type:"string"},{name:"lattitude",type:"float"},{name:"longitude",type:"float"},{name:"velocity",type:"float"},{name:"accelate_x",type:"float"},{name:"accelate_y",type:"float"},{name:"accelate_z",type:"float"},{name:"created_at",type:"date",dateFormat:"time"},{name:"updated_at",type:"date",dateFormat:"time"}],sorters:[{property:"datetime",direction:"ASC"}],proxy:{type:"ajax",url:window.location.pathname.indexOf("/m/")===0?"/incident_log":"data/incident_log.json",reader:{type:"json",rootProperty:"items",totalProperty:"total"}}}});Ext.define("HatioBB.store.DashboardVehicleStore",{extend:"Ext.data.Store",storeId:"dashboard_vehicle_store",config:{fields:[{name:"name",type:"string"},{name:"summary",type:"auto"}],pageSize:1000,proxy:{type:"ajax",url:window.location.pathname.indexOf("/m/")===0?"/dashboard/health/vehicle":"data/dashboard/health/vehicle.json",extraParams:{},reader:{type:"json",rootProperty:"items"}}}});Ext.define("HatioBB.store.VehicleConsumableStore",{extend:"Ext.data.Store",config:{remoteFilter:true,fields:[{name:"key",type:"string"},{name:"vehicle_id",type:"string"},{name:"consumable_item",type:"string"},{name:"repl_unit",type:"string"},{name:"repl_mileage",type:"int"},{name:"repl_time",type:"int"},{name:"last_repl_date",type:"date",dateFormat:"time"},{name:"miles_last_repl",type:"int"},{name:"miles_since_last_repl",type:"int"},{name:"next_repl_mileage",type:"int"},{name:"next_repl_date",type:"date",dateFormat:"time"},{name:"accrued_cost",type:"float"},{name:"health_rate",type:"float"},{name:"status",type:"string"},{name:"created_at",type:"date",dateFormat:"time"},{name:"updated_at",type:"date",dateFormat:"time"}],pageSize:1000,proxy:{type:"ajax",url:window.location.pathname.indexOf("/m/")===0?"/vehicle_consumable":"data/vehicle_consumable.json",reader:{type:"json",rootProperty:"items",totalProperty:"total"}}}});Ext.define("HatioBB.store.DriverRunStore",{extend:"Ext.data.Store",config:{autoLoad:false,remoteFilter:true,groupField:"year",fields:[{name:"driver",type:"string"},{name:"year",type:"integer"},{name:"month",type:"integer"},{name:"month_str",type:"string",},{name:"run_dist",type:"float"},{name:"run_time",type:"integer"},{name:"consmpt",type:"float"},{name:"co2_emss",type:"float"},{name:"effcc",type:"float"},{name:"sud_accel_cnt",type:"integer"},{name:"sud_brake_cnt",type:"integer"},{name:"eco_drv_time",type:"integer"},{name:"ovr_spd_time",type:"integer"},{name:"inc_cnt",type:"integer"}],sorters:[{property:"year",direction:"ASC"},{property:"month",direction:"ASC"}],proxy:{type:"ajax",url:window.location.pathname.indexOf("/m/")===0?"/driver_run":"data/driver_run.json",extraParams:{select:["driver","year","month","run_dist","run_time","consmpt","co2_emss","effcc","sud_accel_cnt","sud_brake_cnt","eco_drv_time","ovr_spd_time","inc_cnt"]},reader:{type:"json",rootProperty:"items",totalProperty:"total"}}}});Ext.define("HatioBB.store.VehicleRunStore",{extend:"Ext.data.Store",config:{autoLoad:false,remoteFilter:true,groupField:"year",fields:[{name:"key",type:"string"},{name:"vehicle",type:"string"},{name:"year",type:"integer",},{name:"month",type:"integer",},{name:"month_str",type:"string",},{name:"run_dist",type:"float"},{name:"run_time",type:"integer"},{name:"consmpt",type:"float"},{name:"co2_emss",type:"float"},{name:"effcc",type:"float"},{name:"oos_cnt",type:"integer"},{name:"mnt_cnt",type:"integer"},{name:"mnt_time",type:"integer"}],sorters:[{property:"year",direction:"ASC"},{property:"month",direction:"ASC"}],proxy:{type:"ajax",url:window.location.pathname.indexOf("/m/")===0?"/vehicle_run":"data/vehicle_run.json",reader:{type:"json",rootProperty:"items",totalProperty:"total"}}}});Ext.define("HatioBB.store.YearStore",{extend:"Ext.data.Store",config:{fields:["year"],data:[]},constructor:function(b){var a=new Date().getFullYear();b.data=b.data||[];for(var c=0;c<10;c++){b.data.push({year:a-c})}this.callParent(arguments)}});Ext.define("HatioBB.store.DashboardConsumableStore",{extend:"Ext.data.Store",config:{storeId:"dashboard_consumable_store",fields:[{name:"consumable",type:"string"},{name:"summary",type:"auto"}],pageSize:1000,proxy:{type:"ajax",url:window.location.pathname.indexOf("/m/")===0?"/dashboard/health/consumable":"data/dashboard/health/consumable.json",extraParams:{},reader:{type:"json",rootProperty:"items"}}}});Ext.define("HatioBB.view.Content",{extend:"Ext.Panel",xtype:"content",config:{title:"GreenFleets",layout:"card",items:[{id:"header",xtype:"header",docked:"top"},{id:"launch",cls:"launchscreen",scrollable:true}]}});Ext.define("HatioBB.view.Header",{extend:"Ext.TitleBar",xtype:"header",config:{title:"GreenFleets",items:[{itemId:"map",target:"monitor_map",align:"left",cls:"headerView navMap",width:50},{itemId:"info",target:"monitor_info",align:"left",cls:"headerView navInfo"},{itemId:"incident",target:"monitor_incident",align:"left",cls:"headerView navIncident"},{itemId:"setting",iconCls:"settings9",iconMask:true,align:"right"},{iconCls:"chat3",iconMask:true,align:"right"},{itemId:"refresh",iconCls:"refresh",iconMask:true,align:"right"},{itemId:"collapse",iconCls:"window",iconMask:true,align:"right"}]},setActiveStatus:function(b){var a=this.down("button[target="+b+"]");Ext.Array.each(a.up().query("button"),function(c){if(a===c){c.addCls("active")}else{c.removeCls("active")}})},clearActiveStatus:function(){Ext.Array.each(this.query("button"),function(a){a.removeCls("active")})}});Ext.define("HatioBB.view.monitor.Map",{extend:"Ext.Map",xtype:"monitor_map",id:"monitor_map",config:{useCurrentLocation:false,mapOptions:{zoom:10,maxZoom:19,minZoom:3,center:new google.maps.LatLng(System.props.lat,System.props.lng),mapTypeId:google.maps.MapTypeId.ROADMAP}},initialize:function(){this.callParent();var a=this;var b=Ext.getStore("VehicleFilteredStore");this.on("painted",function(){a.refreshMap(b);b.on("refresh",a.refreshMap,a);HatioBB.setting.on("vehicle",a.onSelectVehicle,a);HatioBB.setting.on("driver",a.onSelectDriver,a)});this.on("erased",function(){b.un("refresh",a.refreshMap,a);HatioBB.setting.un("vehicle",a.onSelectVehicle,a);HatioBB.setting.un("driver",a.onSelectDriver,a)});this.on("resize",function(){google.maps.event.trigger(a.getMap(),"resize")});this.element.on({delegate:"div.showVehicleTrack",tap:function(){a.fireEvent("tracktap",a.selectedMarker.record)}});this.element.on({delegate:"div.showVehicleInfo",tap:function(){a.fireEvent("vehicletap",a.selectedMarker.record)}});this.element.on({delegate:"div.showDriverInfo",tap:function(){a.fireEvent("drivertap",a.selectedMarker.driver_record)}})},refresh:function(){Ext.getStore("VehicleMapStore").load()},onSelectVehicle:function(){var a=Ext.getStore("VehicleFilteredStore");a.clearFilter(true);a.filter("id",HatioBB.setting.get("vehicle"))},onSelectDriver:function(){var a=Ext.getStore("VehicleFilteredStore");a.clearFilter(true);a.filter("driver_id",HatioBB.setting.get("driver"))},destroy:function(){this.resetMarkers();this.callParent()},getMarkers:function(){if(!this.markers){this.markers={}}return this.markers},resetMarkers:function(){for(var a in this.markers){google.maps.event.clearListeners(this.markers[a]);this.markers[a].setMap(null)}this.clearInfoWindow();this.markers={}},clearInfoWindow:function(){if(this.infowindow){this.infowindow.setVisible(false)}},refreshMap:function(c){var b=this;this.resetMarkers();var a={Running:"resources/images/statusDriving.png",Idle:"resources/images/statusStop.png",Incident:"resources/images/statusIncident.png",Maint:"resources/images/statusMaint.png"};var e;var d=function(){b.clearInfoWindow();var g=this;var f=g.record;var i=Ext.getStore("DriverBriefStore").getById(f.get("driver_id"));g.driver_record=i;b.selectedMarker=g;var h=['<div class="bubbleWrap status'+f.get("status")+'">',i?'<img src="data/image/'+i.get("id")+'.jpg">':'<img src="resources/images/bgDriver.png">','<div class="showVehicleInfo">Vehicle : '+f.get("id")+"("+f.get("registration_number")+")</div>",i?'<div class="showDriverInfo">Driver : '+i.get("id")+"("+i.get("name")+")</div>":'<div class="showDriverInfo">driver : '+T("label.nodriver")+"</div>","</div>"].join("");if(!b.infowindow){b.infowindow=new Label({map:this.getMap()})}b.infowindow.bindTo("position",g,"position");b.infowindow.set("text",h);b.infowindow.setVisible(true)};c.each(function(g){var h=g.get("id");var i=new google.maps.LatLng(g.get("lat"),g.get("lng"));var f=new google.maps.Marker({position:i,map:b.getMap(),icon:a[g.get("status")],record:g});if(!e){e=new google.maps.LatLngBounds(i,i)}else{e.extend(i)}b.getMarkers()[h]=f;google.maps.event.addListener(f,"click",d)},this);if(!e){this.getMap().setCenter(new google.maps.LatLng(System.props.lat,System.props.lng))}else{if(e.isEmpty()||e.getNorthEast().equals(e.getSouthWest())){setTimeout(function(){b.getMap().setCenter(e.getNorthEast());b.getMap().setZoom(HatioBB.setting.get("auto_max_zoom")||16);var g=b.getMarkers();for(var f in g){google.maps.event.trigger(g[f],"click")}},500)}else{if(HatioBB.setting.get("autofit")){this.getMap().fitBounds(e)}}}}});Ext.define("HatioBB.view.monitor.Info",{extend:"Ext.Panel",xtype:"monitor_info",id:"monitor_info",config:{layout:"fit"},constructor:function(b){b.items=[{xtype:"container",layout:{type:"vbox",align:"stretch"},items:[{xtype:"container",height:135,cls:"grayBg",layout:{type:"vbox",align:"stretch"},items:this.buildVehicleInfo()},{xtype:"panel",height:45,itemId:"incidents",cls:"shotHList",layout:{type:"hbox",align:"stretch"}},{xtype:"map",useCurrentLocation:false,flex:1,mapOptions:{zoom:10,maxZoom:19,minZoom:3,center:null,mapTypeId:google.maps.MapTypeId.ROADMAP}}]}];this.callParent(arguments);var a=this;this.on("painted",function(){HatioBB.setting.on("vehicle",a.onSelectVehicle,a);HatioBB.setting.on("driver",a.onSelectDriver,a);a.refresh()});this.on("erased",function(){HatioBB.setting.un("vehicle",a.onSelectVehicle,a);HatioBB.setting.un("driver",a.onSelectDriver,a)});this.on("resize",function(){google.maps.event.trigger(a.getMap(),"resize")})},refresh:function(){this.setVehicle()},onSelectDriver:function(){if(this.onProcessing){return}var a=Ext.getStore("VehicleMapStore");var b=a.findRecord("driver_id",HatioBB.setting.get("driver"));this.setVehicle(b)},onSelectVehicle:function(){if(this.onProcessing){return}var a=Ext.getStore("VehicleMapStore");var b=a.findRecord("id",HatioBB.setting.get("vehicle"));this.setVehicle(b)},setVehicle:function(b){var l=this;if(!b){var i=HatioBB.setting.get("vehicle");if(i){b=Ext.getStore("VehicleMapStore").findRecord("id",i);if(!b&&!this.isHidden()){setTimeout(function(){l.setVehicle()},3000);return}}else{var j=HatioBB.setting.get("driver");if(j){b=Ext.getStore("VehicleMapStore").findRecord("driver_id",i)}else{return}}}if(!b){return}var i=i||b.get("id");var j=j||b.get("driver_id");try{this.onProcessing=true;if(i&&(i!==HatioBB.setting.get("vehicle"))){HatioBB.setting.set("vehicle",i)}if(j&&(j!==HatioBB.setting.get("driver_id"))){HatioBB.setting.set("driver",j)}}finally{this.onProcessing=false}var h=Ext.getStore("VehicleMapStore");var f=h.findRecord("id",b.get("id"));var e=f.get("image_clip");var g=l.sub("vehicleImage");if(e){if(HatioBB.setting.get("app_mode")){g.setSrc("/download?blob-key="+e)}else{g.setSrc(e)}}else{g.setSrc("resources/images/bgVehicle.png")}var d=Ext.getStore("DriverBriefStore");var a=d.findRecord("id",b.get("driver_id"));var k=a.get("id");var c=a.get("image_clip");var m=l.sub("driverImage");if(c){if(HatioBB.setting.get("app_mode")){m.setSrc("/download?blob-key="+c)}else{m.setSrc(c)}}else{m.setSrc("resources/images/bgDriver.png")}b.set("driver_name",a.get("name"));b.set("location","Resolving ..");this.getLocation(b.get("lat"),b.get("lng"),function(n){b.set("location",n);var o=l.down("[itemId=briefInfo]");if(o){o.setData(b.getData())}});this.sub("briefInfo").setData(b.getData());this.getTrackStore().load({params:{vehicle_id:b.get("id"),date:Math.round((new Date().getTime()-(60*60*24*1000))/1000),start:0,limit:1000},callback:function(n){l.refreshMap(n,b)}});this.getIncidentStore().load({params:{vehicle_id:b.get("id"),confirm:false,start:0,limit:4},callback:this.refreshIncidents,scope:this})},getLocation:function(b,a,d){if(b!==undefined&&a!==undefined){var c=new google.maps.LatLng(b,a);geocoder=new google.maps.Geocoder();geocoder.geocode({latLng:c},function(f,e){if(e==google.maps.GeocoderStatus.OK){if(f[0]){d(f[0].formatted_address)}}else{console.log("Geocoder failed due to: "+e)}})}},getTrackLine:function(){return this.trackline},setTrackLine:function(a){if(this.trackline){this.trackline.setMap(null)}this.trackline=a},getMarkers:function(){return this.markers},setMarkers:function(a){if(this.markers){Ext.each(this.markers,function(b){b.setMap(null)})}this.markers=a},resetMarkers:function(){if(this.markers){Ext.each(this.markers,function(a){a.setMap(null)})}this.markers=null},getTrackStore:function(){if(!this.trackStore){this.trackStore=Ext.getStore("TrackByVehicleStore")}return this.trackStore},getIncidentStore:function(){if(!this.incidentStore){this.incidentStore=Ext.getStore("IncidentByVehicleStore")}return this.incidentStore},getMap:function(){if(!this.map){this.map=this.down("map").getMap()}return this.map},refreshMap:function(d,h){this.setTrackLine(new google.maps.Polyline({map:this.getMap(),strokeColor:"#FF0000",strokeOpacity:1,strokeWeight:4}));this.setMarkers(null);var l=this.getTrackLine().getPath();var a;var c;Ext.Array.each(d,function(m){var o=m.get("lattitude");var n=m.get("longitude");if(o!==0||n!==0){c=new google.maps.LatLng(o,n);l.push(c);if(!a){a=new google.maps.LatLngBounds(c,c)}else{a.extend(c)}}});if(l.getLength()===0){var i=h.get("lattitude");var j=h.get("longitude");var f=null;if(i===0&&j===0){f=new google.maps.LatLng(System.props.lat,System.props.lng)}else{f=new google.maps.LatLng(i,j)}l.push(f);a=new google.maps.LatLngBounds(f,f)}if(a.isEmpty()||a.getNorthEast().equals(a.getSouthWest())){this.getMap().setCenter(a.getNorthEast())}else{this.getMap().fitBounds(a)}var g=l.getAt(0);if(g){var b=new google.maps.Marker({position:new google.maps.LatLng(g.lat(),g.lng()),map:this.getMap()});var k=l.getAt(l.getLength()-1);var e=new google.maps.Marker({position:new google.maps.LatLng(k.lat(),k.lng()),icon:"resources/images/iconStartPoint.png",map:this.getMap()});this.setMarkers([b,e])}},refreshIncidents:function(a){var d=this.sub("incidents");d.removeAll();var c=Math.min(a.length,4);for(var b=0;b<4;b++){var e=a[b];if(e){d.add({xtype:"button",flex:1,maxWidth:160,incident:e,html:'<a href="#">'+e.get("vehicle_id")+", "+e.get("driver_id")+"</a><span>"+Ext.Date.format(e.get("datetime"),"D Y-m-d H:i:s")+"</span>"})}else{d.add({xtype:"container",flex:1})}}},buildVehicleInfo:function(){return{xtype:"panel",title:T("title.vehicle_information"),cls:"marginT10 marginL10",layout:{type:"hbox",align:"stretch"},items:[{xtype:"image",itemId:"vehicleImage",cls:"imgVehicle"},{xtype:"image",itemId:"driverImage",cls:"imgDriver"},{xtype:"panel",itemId:"briefInfo",height:100,data:null,tpl:['<div class="infoID {status}">{id} ({registration_number})</div>','<div class="infoText">Driver ID : {driver_id} ({driver_name})</div>','<div class="infoText">Location : {location}</div>']}]}}});Ext.define("HatioBB.view.report.AreaChart",{extend:"Ext.Carousel",xtype:"rpt_area",requires:["Ext.Carousel","Ext.chart.Chart","Ext.chart.axis.Numeric","Ext.chart.axis.Category","Ext.chart.series.Area","Ext.chart.series.Line","Ext.data.JsonStore"],config:{direction:"vertical",cls:"grayBg"},constructor:function(b){var a=new Ext.create("Ext.data.JsonStore",{fields:["name","data1","data2","data3","2003","2004","2005","2006","2007","2008","2009","2010","iphone","android","ipad"],data:this.generateData(5,20)});b.items=[this.buildChart(a),this.buildTable(a)];this.callParent(arguments)},generateData:function(d,b){var c=[],a;b=(!b&&b!==0)?20:b;for(a=0;a<(d||12);a++){c.push({name:Ext.Date.monthNames[a%12],data1:Math.floor(Math.max((Math.random()*100),b)),data2:Math.floor(Math.max((Math.random()*100),b)),data3:Math.floor(Math.max((Math.random()*100),b)),2003:Math.floor(Math.max((Math.random()*100),b)),2004:Math.floor(Math.max((Math.random()*100),b)),2005:Math.floor(Math.max((Math.random()*100),b)),2006:Math.floor(Math.max((Math.random()*100),b)),2007:Math.floor(Math.max((Math.random()*100),b)),2008:Math.floor(Math.max((Math.random()*100),b)),2009:Math.floor(Math.max((Math.random()*100),b)),2010:Math.floor(Math.max((Math.random()*100),b)),iphone:Math.floor(Math.max((Math.random()*100),b)),android:Math.floor(Math.max((Math.random()*100),b)),ipad:Math.floor(Math.max((Math.random()*100),b))})}return c},buildChart:function(a){return{xtype:"chart",store:a,themeCls:"area1",theme:"Demo",animate:true,toolbar:null,legend:{position:{portrait:"right",landscape:"bottom"},labelFont:"20px Arial"},axes:[{type:"Numeric",position:"left",fields:["2003","2004","2005","2006","2007","2008","2009"],title:"Number of Hits",minimum:0,adjustMinimumByMajorUnit:0},{type:"Category",position:"bottom",fields:["name"],title:"Month of the Year"}],series:[{type:"area",highlight:false,axis:"left",xField:"name",yField:["2003","2004","2005","2006","2007","2008","2009"]}]}},buildTable:function(a){return{xtype:"panel",cls:"paddingAll15",data:a.config.data,tpl:["<table class=dataGrid>","<tr>","<th>Name</th>","<th>Data1</th>","<th>Data2</th>","<th>Data3</th>","<th>2003</th>","<th>2004</th>","<th>2005</th>","<th>2006</th>","<th>2007</th>","<th>2008</th>","<th>2009</th>","<th>2010</th>","<th>iPhone</th>","<th>Android</th>","<th>iPad</th>","</tr>",'<tpl for=".">',"<tr>","<td>{name}</td>","<td>{data1}</td>","<td>{data2}</td>","<td>{data3}</td>","<td>{2003}</td>","<td>{2004}</td>","<td>{2005}</td>","<td>{2006}</td>","<td>{2007}</td>","<td>{2008}</td>","<td>{2009}</td>","<td>{2010}</td>","<td>{iphone}</td>","<td>{android}</td>","<td>{ipad}</td>","</tr>","</tpl>","</table>"]}}});Ext.define("HatioBB.view.report.BarChart",{extend:"Ext.Carousel",xtype:"rpt_bar",requires:["Ext.Carousel","Ext.chart.Chart","Ext.chart.axis.Numeric","Ext.chart.axis.Category","Ext.chart.series.Area","Ext.chart.series.Line","Ext.data.JsonStore"],config:{direction:"vertical",cls:"grayBg"},constructor:function(b){var a=new Ext.create("Ext.data.JsonStore",{fields:["name","data1","data2","data3","2003","2004","2005","2006","2007","2008","2009","2010","iphone","android","ipad"],data:this.generateData(5,20)});b.items=[this.buildChart(a),this.buildTable(a)];this.callParent(arguments)},generateData:function(d,b){var c=[],a;b=(!b&&b!==0)?20:b;for(a=0;a<(d||12);a++){c.push({name:Ext.Date.monthNames[a%12],data1:Math.floor(Math.max((Math.random()*100),b)),data2:Math.floor(Math.max((Math.random()*100),b)),data3:Math.floor(Math.max((Math.random()*100),b)),2003:Math.floor(Math.max((Math.random()*100),b)),2004:Math.floor(Math.max((Math.random()*100),b)),2005:Math.floor(Math.max((Math.random()*100),b)),2006:Math.floor(Math.max((Math.random()*100),b)),2007:Math.floor(Math.max((Math.random()*100),b)),2008:Math.floor(Math.max((Math.random()*100),b)),2009:Math.floor(Math.max((Math.random()*100),b)),2010:Math.floor(Math.max((Math.random()*100),b)),iphone:Math.floor(Math.max((Math.random()*100),b)),android:Math.floor(Math.max((Math.random()*100),b)),ipad:Math.floor(Math.max((Math.random()*100),b))})}return c},buildChart:function(a){return{xtype:"chart",store:a,themeCls:"bar1",theme:"Demo",animate:true,shadow:false,toolbar:null,legend:{position:{portrait:"bottom",landscape:"bottom"},labelFont:"17px Arial"},axes:[{type:"Numeric",position:"bottom",fields:["2008","2009","2010"],label:{renderer:function(b){return b.toFixed(0)}},title:"Number of Hits",minimum:0},{type:"Category",position:"left",fields:["name"],title:"Month of the Year"}],series:[{type:"bar",xField:"name",yField:["2008","2009","2010"],axis:"bottom",highlight:true,showInLegend:true}]}},buildTable:function(a){return{xtype:"panel",cls:"paddingAll15",data:a.config.data,tpl:["<table class=dataGrid>","<tr>","<th>Name</th>","<th>Data1</th>","<th>Data2</th>","<th>Data3</th>","<th>2003</th>","<th>2004</th>","<th>2005</th>","<th>2006</th>","<th>2007</th>","<th>2008</th>","<th>2009</th>","<th>2010</th>","<th>iPhone</th>","<th>Android</th>","<th>iPad</th>","</tr>",'<tpl for=".">',"<tr>","<td>{name}</td>","<td>{data1}</td>","<td>{data2}</td>","<td>{data3}</td>","<td>{2003}</td>","<td>{2004}</td>","<td>{2005}</td>","<td>{2006}</td>","<td>{2007}</td>","<td>{2008}</td>","<td>{2009}</td>","<td>{2010}</td>","<td>{iphone}</td>","<td>{android}</td>","<td>{ipad}</td>","</tr>","</tpl>","</table>"]}}});Ext.define("HatioBB.view.report.ColumnChart",{extend:"Ext.Carousel",xtype:"rpt_column",requires:["Ext.Carousel","Ext.chart.Chart","Ext.chart.axis.Numeric","Ext.chart.axis.Category","Ext.chart.series.Column","Ext.data.JsonStore"],config:{direction:"vertical",cls:"grayBg"},constructor:function(b){var a=new Ext.create("Ext.data.JsonStore",{fields:["name","data1","data2","data3","2003","2004","2005","2006","2007","2008","2009","2010","iphone","android","ipad"],data:this.generateData(5,20)});b.items=[this.buildChart(a),this.buildTable(a)];this.callParent(arguments)},generateData:function(d,b){var c=[],a;b=(!b&&b!==0)?20:b;for(a=0;a<(d||12);a++){c.push({name:Ext.Date.monthNames[a%12],data1:Math.floor(Math.max((Math.random()*100),b)),data2:Math.floor(Math.max((Math.random()*100),b)),data3:Math.floor(Math.max((Math.random()*100),b)),2003:Math.floor(Math.max((Math.random()*100),b)),2004:Math.floor(Math.max((Math.random()*100),b)),2005:Math.floor(Math.max((Math.random()*100),b)),2006:Math.floor(Math.max((Math.random()*100),b)),2007:Math.floor(Math.max((Math.random()*100),b)),2008:Math.floor(Math.max((Math.random()*100),b)),2009:Math.floor(Math.max((Math.random()*100),b)),2010:Math.floor(Math.max((Math.random()*100),b)),iphone:Math.floor(Math.max((Math.random()*100),b)),android:Math.floor(Math.max((Math.random()*100),b)),ipad:Math.floor(Math.max((Math.random()*100),b))})}return c},buildChart:function(a){return{xtype:"chart",store:a,themeCls:"column1",animate:{easing:"bounceOut",duration:750},shadow:false,toolbar:null,gradients:[{id:"v-1",angle:0,stops:{0:{color:"rgb(212, 40, 40)"},100:{color:"rgb(117, 14, 14)"}}},{id:"v-2",angle:0,stops:{0:{color:"rgb(180, 216, 42)"},100:{color:"rgb(94, 114, 13)"}}},{id:"v-3",angle:0,stops:{0:{color:"rgb(43, 221, 115)"},100:{color:"rgb(14, 117, 56)"}}},{id:"v-4",angle:0,stops:{0:{color:"rgb(45, 117, 226)"},100:{color:"rgb(14, 56, 117)"}}},{id:"v-5",angle:0,stops:{0:{color:"rgb(187, 45, 222)"},100:{color:"rgb(85, 10, 103)"}}}],axes:[{type:"Numeric",position:"left",fields:["2009"],minimum:0,maximum:100,label:{renderer:function(b){return b.toFixed(0)}},title:"Number of Hits"},{type:"Category",position:"bottom",fields:["name"],title:"Month of the Year"}],series:[{type:"column",axis:"left",highlight:true,renderer:function(e,f,d,c,b){d.fill="url(#v-"+(c%colors.length+1)+")";return d},label:{field:"2009"},xField:"name",yField:"2009"}]}},buildTable:function(a){return{xtype:"panel",cls:"paddingAll15",data:a.config.data,tpl:["<table class=dataGrid>","<tr>","<th>Name</th>","<th>Data1</th>","<th>Data2</th>","<th>Data3</th>","<th>2003</th>","<th>2004</th>","<th>2005</th>","<th>2006</th>","<th>2007</th>","<th>2008</th>","<th>2009</th>","<th>2010</th>","<th>iPhone</th>","<th>Android</th>","<th>iPad</th>","</tr>",'<tpl for=".">',"<tr>","<td>{name}</td>","<td>{data1}</td>","<td>{data2}</td>","<td>{data3}</td>","<td>{2003}</td>","<td>{2004}</td>","<td>{2005}</td>","<td>{2006}</td>","<td>{2007}</td>","<td>{2008}</td>","<td>{2009}</td>","<td>{2010}</td>","<td>{iphone}</td>","<td>{android}</td>","<td>{ipad}</td>","</tr>","</tpl>","</table>"]}}});Ext.define("HatioBB.view.report.LineChart",{extend:"Ext.Carousel",xtype:"rpt_line",requires:["Ext.Carousel","Ext.chart.Chart","Ext.chart.axis.Numeric","Ext.chart.axis.Category","Ext.chart.series.Area","Ext.chart.series.Line","Ext.data.JsonStore"],config:{direction:"vertical",cls:"grayBg"},constructor:function(b){var a=new Ext.create("Ext.data.JsonStore",{fields:["name","data1","data2","data3","2003","2004","2005","2006","2007","2008","2009","2010","iphone","android","ipad","etc"],data:this.generateData(12,20)});b.items=[this.buildChart(a),this.buildTable(a)];this.callParent(arguments)},generateData:function(d,b){var c=[],a;b=(!b&&b!==0)?20:b;for(a=0;a<(d||12);a++){c.push({name:Ext.Date.monthNames[a%12],data1:Math.floor(Math.max((Math.random()*100),b)),data2:Math.floor(Math.max((Math.random()*100),b)),data3:Math.floor(Math.max((Math.random()*100),b)),2003:Math.floor(Math.max((Math.random()*100),b)),2004:Math.floor(Math.max((Math.random()*100),b)),2005:Math.floor(Math.max((Math.random()*100),b)),2006:Math.floor(Math.max((Math.random()*100),b)),2007:Math.floor(Math.max((Math.random()*100),b)),2008:Math.floor(Math.max((Math.random()*100),b)),2009:Math.floor(Math.max((Math.random()*100),b)),2010:Math.floor(Math.max((Math.random()*100),b)),iphone:Math.floor(Math.max((Math.random()*100),b)),android:Math.floor(Math.max((Math.random()*100),b)),ipad:Math.floor(Math.max((Math.random()*100),b)),etc:Math.floor(Math.max((Math.random()*100),b))})}return c},buildChart:function(a){return{xtype:"chart",themeCls:"line1",theme:"Demo",store:a,animate:true,toolbar:null,legend:{position:"bottom"},axes:[{type:"Numeric",minimum:0,maximum:100,position:"left",fields:["iphone","android","ipad"],title:"Number of Hits",minorTickSteps:1,roundToDecimal:true,decimals:0},{type:"Category",position:"bottom",fields:["name"],title:"Month of the Year"}],series:[{type:"line",highlight:{size:7,radius:7},fill:true,smooth:true,axis:"left",xField:"name",yField:"iphone",title:"iPhone"},{type:"line",highlight:{size:7,radius:7},fill:true,axis:"left",smooth:true,xField:"name",yField:"android",title:"Android"},{type:"line",highlight:{size:7,radius:7},axis:"left",smooth:true,xField:"name",yField:"ipad",title:"iPad"}]}},buildTable:function(a){return{xtype:"panel",cls:"paddingAll15",data:a.config.data,tpl:["<table class=dataGrid>","<tr>","<th>Name</th>","<th>Data1</th>","<th>Data2</th>","<th>Data3</th>","<th>2003</th>","<th>2004</th>","<th>2005</th>","<th>2006</th>","<th>2007</th>","<th>2008</th>","<th>2009</th>","<th>2010</th>","<th>iPhone</th>","<th>Android</th>","<th>iPad</th>","<th>etc</th>","</tr>",'<tpl for=".">',"<tr>","<td>{name}</td>","<td>{data1}</td>","<td>{data2}</td>","<td>{data3}</td>","<td>{2003}</td>","<td>{2004}</td>","<td>{2005}</td>","<td>{2006}</td>","<td>{2007}</td>","<td>{2008}</td>","<td>{2009}</td>","<td>{2010}</td>","<td>{iphone}</td>","<td>{android}</td>","<td>{ipad}</td>","<td>{etc}</td>","</tr>","</tpl>","</table>"]}}});Ext.define("HatioBB.view.report.PieChart",{extend:"Ext.Carousel",xtype:"rpt_pie",requires:["Ext.Carousel","Ext.chart.Chart","Ext.chart.axis.Numeric","Ext.chart.axis.Category","Ext.chart.series.Pie","Ext.chart.series.Line","Ext.data.JsonStore"],config:{direction:"vertical",cls:"grayBg"},constructor:function(b){var a=new Ext.create("Ext.data.JsonStore",{fields:["name","data1","data2","data3","2003","2004","2005","2006","2007","2008","2009","2010","iphone","android","ipad"],data:this.generateData(5,20)});b.items=[this.buildChart(a),this.buildTable(a)];this.callParent(arguments)},generateData:function(d,b){var c=[],a;b=(!b&&b!==0)?20:b;for(a=0;a<(d||12);a++){c.push({name:Ext.Date.monthNames[a%12],data1:Math.floor(Math.max((Math.random()*100),b)),data2:Math.floor(Math.max((Math.random()*100),b)),data3:Math.floor(Math.max((Math.random()*100),b)),2003:Math.floor(Math.max((Math.random()*100),b)),2004:Math.floor(Math.max((Math.random()*100),b)),2005:Math.floor(Math.max((Math.random()*100),b)),2006:Math.floor(Math.max((Math.random()*100),b)),2007:Math.floor(Math.max((Math.random()*100),b)),2008:Math.floor(Math.max((Math.random()*100),b)),2009:Math.floor(Math.max((Math.random()*100),b)),2010:Math.floor(Math.max((Math.random()*100),b)),iphone:Math.floor(Math.max((Math.random()*100),b)),android:Math.floor(Math.max((Math.random()*100),b)),ipad:Math.floor(Math.max((Math.random()*100),b))})}return c},buildChart:function(a){return{xtype:"chart",store:a,themeCls:"pie1",theme:"Demo",shadow:false,animate:true,toolbar:null,insetPadding:20,legend:{position:"left"},interactions:[{type:"reset",confirm:true},{type:"rotate"},"itemhighlight",{type:"iteminfo",gesture:"longpress",listeners:{show:function(c,e,b){var d=e.storeItem;b.setHtml(["<ul><li><b>Month: </b>"+d.get("name")+"</li>","<li><b>Value: </b> "+d.get("2007")+"</li></ul>"].join(""))}}}],series:[{type:"pie",field:"2007",showInLegend:true,highlight:false,listeners:{labelOverflow:function(b,c){c.useCallout=true}},callouts:{renderer:function(c,b){c.label.setAttributes({text:b.get("name")},true)},filter:function(){return false},box:{},lines:{"stroke-width":2,offsetFromViz:20},label:{font:"italic 14px Arial"},styles:{font:"14px Arial"}},label:{field:"name"}}]}},buildTable:function(a){return{xtype:"panel",cls:"paddingAll15",data:a.config.data,tpl:["<table class=dataGrid>","<tr>","<th>Name</th>","<th>Data1</th>","<th>Data2</th>","<th>Data3</th>","<th>2003</th>","<th>2004</th>","<th>2005</th>","<th>2006</th>","<th>2007</th>","<th>2008</th>","<th>2009</th>","<th>2010</th>","<th>iPhone</th>","<th>Android</th>","<th>iPad</th>","</tr>",'<tpl for=".">',"<tr>","<td>{name}</td>","<td>{data1}</td>","<td>{data2}</td>","<td>{data3}</td>","<td>{2003}</td>","<td>{2004}</td>","<td>{2005}</td>","<td>{2006}</td>","<td>{2007}</td>","<td>{2008}</td>","<td>{2009}</td>","<td>{2010}</td>","<td>{iphone}</td>","<td>{android}</td>","<td>{ipad}</td>","</tr>","</tpl>","</table>"]}}});Ext.define("HatioBB.view.report.DailyReport",{extend:"Ext.Panel",xtype:"dailyreport",config:{layout:"fit",},constructor:function(a){a.items=[{html:"일일 리포트",docked:"top"},this.buildReport(),{html:"일일 리포트",docked:"bottom"}];this.callParent(arguments)},buildReport:function(){var c={};var b=new Date();b.setDate(b.getDate()-1);c.date=Ext.Date.format(b,T("format.date"));c.driving=[];for(var a=0;a<50;a++){c.driving.push({driver_id:"D00"+(a+1),name:"오현석",vehicle_id:"V001",reg_no:"가 1234",run_dist:340,run_time:247,consmpt:46,effcc:7.8})}c.maint=[];for(var a=0;a<3;a++){c.maint.push({vehicle_id:"V00"+(a+1),reg_no:"가 1234",desc:"정기 점검"})}c.consummable=[];for(var a=0;a<3;a++){c.consummable.push({vehicle_id:"V00"+(a+1),reg_no:"가 1234",part:"엔진 오일"})}return{xtype:"panel",data:c,cls:"grayBg",scrollable:"vertical",tpl:["<div>{date}</div>","<div>운전자 주행 리포트</div>","<table>","<tr>","<th>운전자 ID</th>","<th>운전자 이름</th>","<th>차량 ID</th>","<th>등록번호</th>","<th>주행거리</th>","<th>주행시간</th>","<th>연료소모량</th>","<th>연비</th>","</tr>",'<tpl for="driving">',"<tr>","<td>{driver_id}</td>","<td>{name}</td>","<td>{vehicle_id}</td>","<td>{reg_no}</td>","<td>{run_dist}</td>","<td>{run_time}</td>","<td>{consmpt}</td>","<td>{effcc}</td>","</tr>","</tpl>","</table>","<div></div>","<div>정비 리포트</div>","<table>","<tr>","<th>차량 ID</th>","<th>등록번호</th>","<th>정비내역</th>","</tr>",'<tpl for="maint">',"<tr>","<td>{vehicle_id}</td>","<td>{reg_no}</td>","<td>{desc}</td>","</tr>","</tpl>","</table>","<div></div>","<div>소모품 교체 리포트</div>","<table>","<tr>","<th>차량 ID</th>","<th>등록번호</th>","<th>소모품</th>","</tr>",'<tpl for="consummable">',"<tr>","<td>{vehicle_id}</td>","<td>{reg_no}</td>","<td>{part}</td>","</tr>","</tpl>","</table>",]}}});Ext.define("HatioBB.view.report.MonthlyReport",{extend:"Ext.Panel",xtype:"monthlyreport",config:{layout:"fit",},constructor:function(a){a.items=[{html:"월간 리포트",docked:"top"},this.buildReport(),{html:"월간 리포트",docked:"bottom"}];this.callParent(arguments)},buildReport:function(){var b={};var e=new Date();e.setMonth(e.getMonth()-1);b.year=e.getFullYear();b.month=e.getMonth()+1;b.driving=[];for(var a=0;a<3;a++){var d=new Date();d.setMonth(d.getMonth()-(a+1));b.driving.push({year:d.getFullYear(),month:d.getMonth()+1,run_dist:340,run_time:247,consmpt:46,effcc:7.8})}b.maint=[];for(var a=0;a<3;a++){var d=new Date();d.setMonth(d.getMonth()-(a+1));b.maint.push({year:d.getFullYear(),month:d.getMonth()+1,count:Math.floor(Math.random()*10)})}var c=["엔진오일","에어컨필터","브레이크오일","냉각수","타이밍벨트"];b.consummable=Ext.Array.map(c,function(f){return{part:f,count:Math.floor(Math.random()*10)}});return{xtype:"panel",data:b,cls:"grayBg",scrollable:"vertical",tpl:["<div>{year}-{month}월</div>","<div>주행 추이 리포트</div>","<table>","<tr>","<th>년도</th>","<th>월</th>","<th>주행거리</th>","<th>주행시간</th>","<th>연료소모량</th>","<th>연비</th>","</tr>",'<tpl for="driving">',"<tr>","<td>{year}</td>","<td>{month}</td>","<td>{run_dist}</td>","<td>{run_time}</td>","<td>{consmpt}</td>","<td>{effcc}</td>","</tr>","</tpl>","</table>","<div></div>","<div>정비 추이 리포트</div>","<table>","<tr>","<th>년도</th>","<th>월</th>","<th>횟수</th>","</tr>",'<tpl for="maint">',"<tr>","<td>{year}</td>","<td>{month}</td>","<td>{count}</td>","</tr>","</tpl>","</table>","<div></div>","<div>소모품 교체 리포트</div>","<table>","<tr>","<th>소모품 파트</th>","<th>횟수</th>","</tr>",'<tpl for="consummable">',"<tr>","<td>{part}</td>","<td>{count}</td>","</tr>","</tpl>","</table>",]}}});Ext.define("HatioBB.view.chart.vehicle.VehicleHealth",{extend:"Ext.Panel",xtype:"chart_v_health",requires:["Ext.chart.Chart","Ext.chart.axis.Numeric","Ext.chart.axis.Category","Ext.chart.series.Pie"],config:{title:T("title.vehicle_health"),cls:"grayBg",layout:"fit"},constructor:function(b){var a=this;b.items=[this.buildChart()];this.callParent(arguments);var c=Ext.getStore("DashboardVehicleStore");c.load({scope:this,callback:function(e,d,h){var g=[];for(var f=0;f<e.length;f++){if(e[f].data.name==="health"){g=e[f].get("summary");break}}a.down("chart").getStore().setData(g)}})},buildChart:function(){return{xtype:"chart",itemId:"xxx",themeCls:"pie1",theme:"Demo",shadow:false,animate:true,toolbar:null,insetPadding:20,legend:{position:"left",labelFont:"10px",boxStroke:"#cfcfcf"},store:Ext.create("Ext.data.JsonStore",{fields:["name","value"],data:[]}),interactions:["reset","rotate","itemhighlight",{type:"iteminfo",gesture:"longpress",listeners:{show:function(c,d,b){var a=d.storeItem;b.setHtml(["<b>Vehicles in the "+a.get("name")+" state :</b>","<ul><li> Count : "+a.get("value")+"</li></ul>"].join(""))}}}],series:[{type:"pie",field:"value",showInLegend:true,donut:false,tips:{trackMouse:true,width:140,height:25,renderer:function(f,e){var d=0;store.each(function(g){d+=g.get(idx)});var a=f.get("name");var c=f.get("value");var b=Math.round(c/d*100);this.setTitle(a+" : "+c+"("+b+"%)")}},colorSet:["#00aa00","#ffff00","#aa0000"],highlight:{segment:{margin:20}},label:{field:"name",display:"rotate",contrast:true,font:"14px Arial"}}]}}});Ext.define("HatioBB.view.nav.NavMenu",{extend:"Ext.dataview.List",xtype:"nav_menu",requires:["Ext.dataview.List"],initialize:function(){this.callParent()},config:{disclosure:true,grouped:true,itemTpl:'<div class="menu"><strong>{text}</strong></div>'}});Ext.define("HatioBB.view.nav.NavVehicle",{extend:"Ext.dataview.List",xtype:"nav_vehicle",requires:["Ext.dataview.List"],initialize:function(){this.callParent();var a=this;this.on("painted",function(){HatioBB.setting.on("vehicle",a.onVehicle,a);a.onVehicle()});this.on("erased",function(){HatioBB.setting.un("vehicle",a.onVehicle,a)})},config:{title:"Vehicles",cls:"x-button-icon",disclosure:true,store:"VehicleMapStore",itemTpl:'<div class="iconVehicle"><strong>{id}</strong> {registration_number}</div>',onItemDisclosure:true},onVehicle:function(){var a=HatioBB.setting.get("vehicle");if(a){this.select(this.getStore().find("id",a))}}});Ext.define("HatioBB.view.nav.NavDriver",{extend:"Ext.dataview.List",xtype:"nav_driver",requires:["Ext.dataview.List"],initialize:function(){this.callParent();var a=this;this.on("painted",function(){HatioBB.setting.on("driver",a.onDriver,a);a.onDriver()});this.on("erased",function(){HatioBB.setting.un("driver",a.onDriver,a)})},config:{title:"Drivers",disclosure:true,store:"DriverBriefStore",itemTpl:'<div class="iconDriver"><strong>{id}</strong> {name}</div>',onItemDisclosure:true},onDriver:function(){var a=HatioBB.setting.get("driver");if(a){this.select(this.getStore().find("id",a))}}});Ext.define("HatioBB.view.nav.NavFav",{extend:"Ext.Panel",xtype:"nav_fav",requires:["Ext.dataview.List"],config:{title:"Favorites",layout:"vbox",items:[{tpl:["<div>123</div>"].join("")}],record:null}});Ext.define("HatioBB.view.nav.NavComm",{extend:"Ext.Panel",xtype:"nav_comm",requires:["Ext.dataview.List"],config:{title:"Communication",layout:"vbox",items:[{tpl:["<div>123</div>"].join("")}],record:null}});Ext.define("HatioBB.view.nav.NavNoti",{extend:"Ext.Panel",xtype:"nav_noti",requires:["Ext.dataview.List"],config:{title:"Notification",layout:"vbox",items:[{tpl:["<div>123</div>"].join("")}],record:null}});Ext.define("HatioBB.view.nav.NavReport",{extend:"Ext.dataview.List",xtype:"nav_report",requires:["Ext.dataview.List","HatioBB.view.chart.vehicle.VehicleHealth"],config:{title:"Reports",disclosure:true,store:Ext.create("Ext.data.Store",{fields:["reportId","desc"],data:[{reportId:"dailyreport",name:"Daily Report",desc:"Daily Report"},{reportId:"monthlyreport",name:"Monthly Report",desc:"Monthly Report"},{reportId:"chart_v_health",name:"Vehicle Health Report",desc:"Vehicle Health Report"},{reportId:"rpt_area",name:"Eco-Driving Report",desc:"Eco-Driving Report"},{reportId:"rpt_pie",name:"Vehicle Stat. Report",desc:"Vehicle Stat. Report"},{reportId:"rpt_pie",name:"Driver Stat. Report",desc:"Driver Stat. Report"},{reportId:"rpt_pie",name:"Driving Report",desc:"Driving Report"},{reportId:"rpt_pie",name:"Efficiency Report",desc:"Efficiency Report"}]}),itemTpl:'<div class="iconChart"><strong>{desc}</strong></div>'}});Ext.define("HatioBB.view.chart.vehicle.Accel",{extend:"Ext.Panel",xtype:"chart_v_accel",requires:["Ext.chart.Chart","Ext.chart.axis.Numeric","Ext.chart.axis.Category","Ext.chart.series.Line",],config:{title:T("title.chart_v_accel"),cls:"grayBg",layout:"fit"},constructor:function(b){var a=this;this.callParent(arguments);var c=this.add(this.buildChart());this.loadHandler=function(e,d,f){c.getStore().setData(d)};Ext.getStore("IncidentLogStore").on("load",this.loadHandler)},destroy:function(){Ext.getStore("IncidentLogStore").un("load",this.loadHandler);this.callParent(arguments)},buildChart:function(){var a=Ext.create("Ext.data.JsonStore",{fields:["datetime","accelate_x","accelate_y","accelate_z","velocity"]});return{xtype:"chart",itemId:"chart",animate:true,legend:{position:{portrait:"bottom",landscape:"bottom"},labelFont:"20px Arial",itemSpacing:5,padding:0,boxStroke:"transparent",boxFill:"transparent"},store:a,axes:[{title:T("label.acceleration"),type:"Numeric",position:"left",fields:["accelate_x","accelate_y","accelate_z"]},{title:T("label.velocity"),type:"Numeric",position:"right",fields:["velocity"]},{title:T("label.time"),type:"Time",position:"bottom",fields:["datetime"],dateFormat:"H:i:s",step:[Ext.Date.SECOND,1],label:{rotate:{degrees:45}}}],series:[{type:"line",highlight:{size:7,radius:7},fill:false,smooth:true,axis:"left",title:T("label.accelerate_x",{x:"x"}),xField:"datetime",yField:"accelate_x"},{type:"line",highlight:{size:7,radius:7},fill:false,smooth:true,axis:"left",title:T("label.accelerate_x",{x:"y"}),xField:"datetime",yField:"accelate_y"},{type:"line",highlight:{size:7,radius:7},fill:false,smooth:true,axis:"left",title:T("label.accelerate_x",{x:"z"}),xField:"datetime",yField:"accelate_z"},{type:"line",highlight:{size:7,radius:7},fill:false,smooth:true,axis:"right",title:T("label.velocity"),xField:"datetime",yField:"velocity"}]}}});Ext.define("HatioBB.view.driver.Summary",{extend:"Ext.form.Panel",requires:["Ext.form.FieldSet"],xtype:"driver_summary",config:{scrollable:true,cls:"grayBg",layout:{type:"vbox",align:"stretch"}},constructor:function(b){b.items=[this.buildDriverInfo(),{xtype:"container",itemId:"links",height:45,cls:"shotHList marginT10 divHAlign",html:['<div class="iconTime">Total Drive Time<span>5,500 min</span></div>','<div class="iconMap">Move to<span>Current Position Map</span></div>','<div class="iconTrack">Move to<span>Recent Running Track</span></div>',].join("")},{xtype:"container",flex:1,layout:{type:"hbox",align:"stretch"},items:[this.buildRunningInfo(),this.buildEcoDrivingInfo()]}];this.callParent(arguments);var a=this;this.on("painted",function(){HatioBB.setting.on("driver",this.refresh,this);this.refresh()});this.on("erased",function(){HatioBB.setting.un("driver",this.refresh,this)});this.element.on({delegate:"div.iconMap",tap:function(){var c=Ext.getStore("VehicleMapStore").findRecord("driver_id",a.driver);if(c){a.fireEvent("showMap",c.get("id"))}}});this.element.on({delegate:"div.iconTrack",tap:function(){var c=Ext.getStore("VehicleMapStore").findRecord("driver_id",a.driver);if(c){a.fireEvent("showTrack",c.get("id"))}}})},refresh:function(){var b=this;if(HatioBB.setting.get("driver")===this.driver){return}var a=Ext.getStore("DriverStore");this.driver=HatioBB.setting.get("driver");a.filter("id",this.driver);a.load(function(c){b.setRecord(c[0]);b.down("[itemId=briefInfo]").setData(c[0].getData());b.down("[itemId=briefInfo2]").setData(c[0].getData());b.down("[itemId=runningInfo]").setData(c[0].getData());var e=c[0].get("image_clip");var d=b.down("[itemId=driverImage]");if(e){if(HatioBB.setting.get("app_mode")){d.setSrc("/download?blob-key="+e)}else{d.setSrc(e)}}else{d.setSrc("resources/images/bgDriver.png")}})},buildDriverInfo:function(){return{xtype:"panel",title:T("title.driver_information"),cls:"marginT10 marginL10",layout:{type:"hbox",align:"stretch"},items:[{xtype:"image",itemId:"driverImage",cls:"imgDriver"},{xtype:"panel",itemId:"briefInfo",flex:1,data:null,tpl:['<div class="infoID">'+T("label.id")+" : {id}</div>",'<div class="infoText">'+T("label.division")+" : {division}</div>",'<div class="infoText">'+T("label.title")+" : {title}</div>",]},{xtype:"panel",itemId:"briefInfo2",flex:1,data:null,tpl:['<div class="infoID">'+T("label.name")+" : {name}</div>",'<div class="infoText">'+T("label.x_id",{x:T("label.social")})+" : {social_id}</div>",'<div class="infoText">'+T("label.phone_x",{x:1})+" : {phone_no_1}</div>",]}]}},buildRunningInfo:function(){return{xtype:"panel",itemId:"runningInfo",data:null,flex:1,cls:"paddingT25 paddingR10 paddingL10",tpl:['<div class="distance">','<div class="total">총 주행거리<span class="km">{total_distance} km</span><span class="mile">159071.025 mile</span></div>','<div class="current">이달 주행거리<span class="km">202.7 km</span><span class="mile">0.125952 mile</span></div>',"</div>",'<div class="fuel">',"<div>이달 연료 소모량 : <span>170ℓ</span></div>","<div>이달 연비 : <span>7km/ℓ</span></div>","</div>"]}},buildEcoDrivingInfo:function(){return{xtype:"panel",flex:1,cls:"bgHGrident",width:265,html:['<div class="subtitle">my eco level</div>','<div class="ecoLevel D"></div>','<div class="ecoHBox">',"<div>공인연비 <span>70%</span></div>","<div>경제주행 비율<span>34%</span></div>","</div>",'<div class="ecoComment">이 차의 에코드라이브 지수는 B레벨입니다.<br/> 공회전시간을 적절하게 관리하면, <span>연간 40만원 이상의</span>유류비 절약이 가능합니다.'].join("")}}});Ext.define("HatioBB.view.chart.driver.Running",{extend:"Ext.Panel",xtype:"chart_d_running",requires:["Ext.chart.Chart","Ext.chart.axis.Numeric","Ext.chart.axis.Category"],config:{title:T("title.chart_d_running"),cls:"grayBg",layout:{type:"vbox",align:"stretch"}},constructor:function(b){var a=this;this.callParent(arguments);this.chartStore=Ext.create("Ext.data.JsonStore",{fields:["year","month","consmpt","oos_cnt","co2_emss","mnt_time","mnt_cnt","run_dist","run_time","effcc"],data:[]});this.add(this.buildRunChart(this.chartStore));this.add(this.buildFuelChart(this.chartStore));this.on("painted",function(){HatioBB.setting.on("driver",this.refresh,this);HatioBB.setting.on("fromYear",this.refresh,this);this.refresh()});this.on("erased",function(){HatioBB.setting.un("driver",this.refresh,this);HatioBB.setting.un("fromYear",this.refresh,this)})},getChart:function(){if(!this.chart){this.chart=this.getAt(0)}return this.chart},refresh:function(d,c){if(HatioBB.setting.get("driver")===this.driver&&HatioBB.setting.get("fromYear")===this.fromYear){return}var b=this;var d=Ext.getStore("DriverRunStore");var e=new Date().getFullYear();var a=new Date().getMonth()+1;this.driver=HatioBB.setting.get("driver");this.fromYear=HatioBB.setting.get("fromYear")||(e-1);var f=d.getProxy();f.config.extraParams.driver=this.driver;f.config.extraParams.from_year=this.fromYear;f.config.extraParams.to_year=e;f.config.extraParams.from_month=1;f.config.extraParams.to_month=a;d.load(function(g){b.chartStore.setData(g)})},buildRunChart:function(a){return{xtype:"chart",store:a,animate:true,shadow:false,toolbar:null,flex:1,legend:{position:{portrait:"bottom",landscape:"bottom"},labelFont:"17px Arial"},axes:[{type:"Category",position:"bottom",fields:["month_str"],title:"Month of the Year"},{type:"Numeric",position:"left",fields:["run_time"],title:"Run Minutes",minimum:0},{type:"Numeric",position:"right",fields:["run_dist"],title:"Run Distance",minimum:0}],series:[{type:"column",highlight:{size:7,radius:7},fill:true,smooth:true,axis:"left",xField:"month_str",yField:"run_time",title:"Run Minutes"},{type:"line",highlight:{size:7,radius:7},fill:true,smooth:true,axis:"right",xField:"month_str",yField:"run_dist",title:"Run Distance"}]}},buildFuelChart:function(a){return{xtype:"chart",store:a,animate:true,shadow:false,toolbar:null,flex:1,legend:{position:{portrait:"bottom",landscape:"bottom"},labelFont:"17px Arial"},axes:[{type:"Category",position:"bottom",fields:["month_str"],title:"Month of the Year"},{type:"Numeric",position:"left",fields:["consmpt"],title:"Fuel Consumption",minimum:0},{type:"Numeric",position:"right",fields:["effcc"],title:"Fuel Efficiency",minimum:0}],series:[{type:"column",highlight:{size:7,radius:7},smooth:true,axis:"left",xField:"month_str",yField:["consmpt"],title:"Fuel Consumption"},{type:"line",highlight:{size:7,radius:7},fill:true,smooth:true,axis:"right",xField:"month_str",yField:"effcc",title:"Fuel Efficiency"}]}}});Ext.define("HatioBB.view.chart.driver.EcoRadar",{extend:"Ext.Panel",xtype:"chart_d_eco_radar",requires:["Ext.chart.Chart","Ext.chart.axis.Numeric","Ext.chart.axis.Category"],config:{title:T("title.chart_d_eco_radar"),cls:"grayBg",layout:"fit"},constructor:function(b){var a=this;this.callParent(arguments);this.on("painted",function(){HatioBB.setting.on("driver",this.refresh,this);HatioBB.setting.on("fromYear",this.refresh,this);this.refresh()});this.on("erased",function(){HatioBB.setting.un("driver",this.refresh,this);HatioBB.setting.un("fromYear",this.refresh,this)})},refresh:function(d,c){if(HatioBB.setting.get("driver")===this.driver&&HatioBB.setting.get("fromYear")===this.fromYear){return}var b=this;var d=Ext.getStore("DriverRunStore");var e=new Date().getFullYear();var a=new Date().getMonth()+1;this.driver=HatioBB.setting.get("driver");this.fromYear=HatioBB.setting.get("fromYear")||(e-1);var f=d.getProxy();f.config.extraParams.driver=this.driver;f.config.extraParams.from_year=this.fromYear;f.config.extraParams.to_year=e;f.config.extraParams.from_month=1;f.config.extraParams.to_month=a;d.load(function(j){var i=this.getGroups();var l={ecoDrvTime:{name:T("label.x_time",{x:T("label.eco_driving")})},efficiency:{name:T("label.fuel_efficiency")},overSpdCnt:{name:T("label.x_time",{x:T("label.over_speeding")})},sudAccelCnt:{name:T("label.x_count",{x:T("label.sudden_accel")})},sudBrakeCnt:{name:T("label.x_count",{x:T("label.sudden_brake")})},};var h=[];Ext.Array.each(i,function(u){var r=u.name.toString();var n=u.children;var s=0;var q=0;var o=0;var m=0;var t=0;var p=0;Ext.each(n,function(v){if(v.get("driver")){s+=1}if(v.get("eco_drv_time")){q+=v.get("eco_drv_time")}if(v.get("effcc")){o+=v.get("effcc")}if(v.get("ovr_spd_time")){m+=v.get("ovr_spd_time")}if(v.get("sud_accel_cnt")){t+=v.get("sud_accel_cnt")}if(v.get("sud_brake_cnt")){p+=v.get("sud_brake_cnt")}});q=q/s;o=o/s;m=m/s;t=t/s;p=p/s;l.ecoDrvTime[r]=q;l.efficiency[r]=o;l.overSpdCnt[r]=m;l.sudAccelCnt[r]=t;l.sudBrakeCnt[r]=p;h.push(r)});var k=[];for(var g in l){k.push(l[g])}if(b.chart){b.remove(b.chart)}b.chart=b.add(b.buildChart(h,k))})},buildChart:function(a,d){var b=Ext.create("Ext.data.JsonStore",{fields:Ext.Array.merge(a,["name"]),data:d});var c=Ext.Array.map(a,function(e){return{showInLegend:false,showMarkers:true,type:"radar",xField:"name",yField:e,style:{opacity:0.4},markerConfig:{radius:3,size:5}}});return{xtype:"chart",themeCls:"radar1",theme:"Demo",insetPadding:30,shadow:true,animate:true,store:b,interactions:["rotate","reset"],legend:{position:"bottom"},axes:[{type:"Radial",position:"radial",label:{display:true}}],series:c}}});Ext.define("HatioBB.view.vehicle.Summary",{extend:"Ext.Panel",xtype:"vehicle_summary",config:{scrollable:true,cls:"grayBg",layout:{type:"vbox",align:"stretch"}},constructor:function(b){b.items=[this.buildVehicleInfo(),{xtype:"container",itemId:"links",height:45,cls:"shotHList marginT10 divHAlign",html:['<div class="iconFuel">Remaining Fuel<span>25</span></div>','<div class="iconTime">Total Drive Time<span>5,500 min</span></div>','<div class="iconMap">Move to<span>Current Position Map</span></div>','<div class="iconTrack">Move to<span>Recent Running Track</span></div>',].join("")},{xtype:"container",flex:1,layout:{type:"hbox",align:"stretch"},items:[{xtype:"container",flex:1,layout:{type:"vbox",align:"stretch"},items:[this.buildRunningInfo(),this.buildConsumableInfo(),this.buildMaintenenceInfo()]},this.buildEcoDrivingInfo()]}];this.callParent(arguments);var a=this;this.on("painted",function(){HatioBB.setting.on("vehicle",this.refresh,this);this.refresh()});this.on("erased",function(){HatioBB.setting.un("vehicle",this.refresh,this)});this.element.on({delegate:"div.iconMap",tap:function(){a.fireEvent("showMap",a.vehicle)}});this.element.on({delegate:"div.iconTrack",tap:function(){a.fireEvent("showTrack",a.vehicle)}})},refresh:function(){var b=this;if(HatioBB.setting.get("vehicle")===this.vehicle){return}var a=Ext.getStore("VehicleStore");this.vehicle=HatioBB.setting.get("vehicle");a.filter("id",this.vehicle);a.load(function(d){b.setRecord(d[0]);b.down("[itemId=briefInfo]").setData(d[0].getData());b.down("[itemId=briefInfo2]").setData(d[0].getData());b.down("[itemId=runningInfo]").setData(d[0].getData());var e=d[0].get("image_clip");var c=b.down("[itemId=vehicleImage]");if(e){if(HatioBB.setting.get("app_mode")){c.setSrc("/download?blob-key="+e)}else{c.setSrc(e)}}else{c.setSrc("resources/images/bgVehicle.png")}})},buildVehicleInfo:function(){return{xtype:"panel",title:T("title.vehicle_information"),cls:"marginT10 marginL10",layout:{type:"hbox",align:"stretch"},items:[{xtype:"image",itemId:"vehicleImage",cls:"imgVehicle"},{xtype:"panel",itemId:"briefInfo",flex:1,data:null,tpl:['<div class="infoID {status}">{id}</div>','<div class="infoText">'+T("label.x_type",{x:T("label.vehicle")})+" : {vehicle_type}</div>",'<div class="infoText">'+T("label.manufacturer")+" : {manufacturer}</div>",]},{xtype:"panel",itemId:"briefInfo2",flex:1,data:null,tpl:['<div class="infoID">'+T("label.reg_no")+" : {registration_number}</div>",'<div class="infoText">'+T("label.birth_year")+" : {birth_year}</div>",'<div class="infoText">'+T("label.fuel_type")+" : {fuel_type}</div>"]}]}},buildRunningInfo:function(){return{xtype:"panel",itemId:"runningInfo",data:null,flex:1,cls:"paddingT25 paddingR10 paddingL10",tpl:['<div class="distance">','<div class="total">총 주행거리<span class="km">{total_distance} km</span><span class="mile">159071.025 mile</span></div>','<div class="current">이달 주행거리<span class="km">202.7 km</span><span class="mile">0.125952 mile</span></div>',"</div>",'<div class="fuel">',"<div>이달 연료 소모량 : <span>170ℓ</span></div>","<div>이달 연비 : <span>7km/ℓ</span></div>","</div>"]}},buildConsumableInfo:function(){return{xtype:"panel",flex:1,cls:"summaryConsumable",html:['<div class="subtitle">consumable</div>','<div class="itemCell">Engine Oil <div class="percent"><span style="width:100%">112%</span></div></div>','<div class="itemCell">Battery <div class="percent"><span style="width:86%">86%</span></div></div>','<div class="itemCell">Antifreeze <div class="percent"><span style="width:95%">95%</span></div></div>',].join("")}},buildMaintenenceInfo:function(){return{xtype:"panel",flex:1,cls:"summaryRepair",html:['<div class="subtitle">repair</div>','<div class="itemCell">2012년 1월 31일에 정비를 하였으며,<br/>다음 정비 예정일은 2012년 6월 30일 입니다.</div>'].join("")}},buildEcoDrivingInfo:function(){return{xtype:"panel",cls:"bgHGrident",width:265,html:['<div class="subtitle">my eco level</div>','<div class="ecoLevel B"></div>','<div class="ecoHBox">',"<div>공인연비 <span>70%</span></div>","<div>경제주행 비율<span>34%</span></div>","</div>",'<div class="ecoComment">이 차의 에코드라이브 지수는 B레벨입니다.<br/> 공회전시간을 적절하게 관리하면, <span>연간 40만원 이상의</span>유류비 절약이 가능합니다.'].join("")}}});Ext.define("HatioBB.view.chart.vehicle.Running",{extend:"Ext.Panel",xtype:"chart_v_running",requires:["Ext.chart.Chart","Ext.chart.axis.Numeric","Ext.chart.axis.Category"],config:{title:T("title.chart_v_running"),cls:"grayBg",layout:{type:"vbox",align:"stretch"}},constructor:function(b){var a=this;this.callParent(arguments);this.chartStore=Ext.create("Ext.data.JsonStore",{fields:["year","month","consmpt","oos_cnt","co2_emss","mnt_time","mnt_cnt","run_dist","run_time","effcc"],data:[]});this.add(this.buildRunChart(this.chartStore));this.add(this.buildFuelChart(this.chartStore));this.on("painted",function(){HatioBB.setting.on("vehicle",this.refresh,this);HatioBB.setting.on("fromYear",this.refresh,this);this.refresh()});this.on("erased",function(){HatioBB.setting.un("vehicle",this.refresh,this);HatioBB.setting.un("fromYear",this.refresh,this)})},getChart:function(){if(!this.chart){this.chart=this.getAt(0)}return this.chart},refresh:function(d,c){if(HatioBB.setting.get("vehicle")===this.vehicle&&HatioBB.setting.get("fromYear")===this.fromYear){return}var b=this;var d=Ext.getStore("VehicleRunStore");var e=new Date().getFullYear();var a=new Date().getMonth()+1;this.vehicle=HatioBB.setting.get("vehicle");this.fromYear=HatioBB.setting.get("fromYear")||(e-1);var f=d.getProxy();f.config.extraParams.vehicle=this.vehicle;f.config.extraParams.from_year=this.fromYear;f.config.extraParams.to_year=e;f.config.extraParams.from_month=1;f.config.extraParams.to_month=a;d.load(function(g){b.chartStore.setData(g)})},buildRunChart:function(a){return{xtype:"chart",store:a,animate:true,shadow:false,toolbar:null,flex:1,legend:{position:{portrait:"bottom",landscape:"bottom"},labelFont:"17px Arial"},axes:[{type:"Category",position:"bottom",fields:["month_str"],title:"Month of the Year"},{type:"Numeric",position:"left",fields:["run_time"],title:"Run Minutes",minimum:0},{type:"Numeric",position:"right",fields:["run_dist"],title:"Run Distance",minimum:0}],series:[{type:"column",highlight:{size:7,radius:7},fill:true,smooth:true,axis:"left",xField:"month_str",yField:"run_time",title:"Run Minutes"},{type:"line",highlight:{size:7,radius:7},fill:true,smooth:true,axis:"right",xField:"month_str",yField:"run_dist",title:"Run Distance"}]}},buildFuelChart:function(a){return{xtype:"chart",store:a,animate:true,shadow:false,toolbar:null,flex:1,legend:{position:{portrait:"bottom",landscape:"bottom"},labelFont:"17px Arial"},axes:[{type:"Category",position:"bottom",fields:["month_str"],title:"Month of the Year"},{type:"Numeric",position:"left",fields:["consmpt"],title:"Fuel Consumption",minimum:0},{type:"Numeric",position:"right",fields:["effcc"],title:"Fuel Efficiency",minimum:0}],series:[{type:"column",highlight:{size:7,radius:7},smooth:true,axis:"left",xField:"month_str",yField:["consmpt"],title:"Fuel Consumption"},{type:"line",highlight:{size:7,radius:7},fill:true,smooth:true,axis:"right",xField:"month_str",yField:"effcc",title:"Fuel Efficiency"}]}}});Ext.define("HatioBB.view.chart.vehicle.Consumable",{extend:"Ext.Panel",xtype:"chart_v_consumable",requires:["Ext.chart.Chart","Ext.chart.axis.Numeric","Ext.chart.axis.Category","Ext.chart.series.Column",],config:{title:T("title.chart_v_consumable"),cls:"grayBg",layout:"fit"},constructor:function(b){var a=this;this.callParent(arguments);var c=this.add(this.buildChart());this.on("painted",function(){HatioBB.setting.on("vehicle",this.refresh,this);this.refresh()});this.on("erased",function(){HatioBB.setting.un("vehicle",this.refresh,this)})},getChart:function(){if(!this.chart){this.chart=this.getAt(0)}return this.chart},refresh:function(){if(HatioBB.setting.get("vehicle")===this.vehicle){return}var b=this;this.vehicle=HatioBB.setting.get("vehicle");var a=Ext.getStore("VehicleConsumableStore");this.vehicle=HatioBB.setting.get("vehicle");var c=a.getProxy();c.config.extraParams.vehicle_id=this.vehicle;a.load(function(d){b.getChart().getStore().setData(d)})},buildChart:function(a){var a=new Ext.create("Ext.data.JsonStore",{fields:["consumable_item","health_rate","repl_unit","status","next_repl_mileage","miles_since_last_repl","repl_mileage","accrued_cost","repl_time","miles_last_repl"],data:[]});return{xtype:"chart",store:a,themeCls:"column1",animate:{easing:"bounceOut",duration:750},shadow:false,toolbar:null,gradients:[{id:"overdue",angle:0,stops:{0:{color:"rgb(212, 40, 40)"},70:{color:"rgb(212, 216, 42)"},100:{color:"rgb(14, 117, 14)"}}},{id:"impending",angle:0,stops:{0:{color:"rgb(242, 176, 40)"},20:{color:"rgb(212, 216, 42)"},100:{color:"rgb(14, 117, 14)"}}},{id:"healthy",angle:0,stops:{100:{color:"rgb(14, 117, 14)"}}}],axes:[{type:"Numeric",position:"left",fields:["health_rate"],grid:{stroke:"#ccc"},label:{renderer:function(b){return Math.floor(b*100)}},title:"Health Rate",majorTickSteps:10},{type:"Category",position:"bottom",fields:["consumable_item"],title:"Consumable Item",label:{rotate:{degrees:315}}}],series:[{type:"column",axis:"left",highlight:true,renderer:function(f,g,e,d,c){var b=g.get("health_rate");if(b>1){e.fill="url(#overdue)"}else{if(b>0.9){e.fill="url(#impending)"}else{e.fill="url(#healthy)"}}return e},listeners:{itemtap:function(b,c){}},label:{display:"outside","text-anchor":"middle",field:"status",orientation:"horizontal",color:"#333",},xField:"consumable_item",yField:"health_rate"}]}}});Ext.define("HatioBB.view.vehicle.Repair",{extend:"Ext.Panel",xtype:"vehicle_repair",config:{cls:"grayBg",html:"Repair"}});Ext.define("HatioBB.view.chart.vehicle.EcoRadar",{extend:"Ext.Panel",xtype:"chart_v_eco_radar",requires:["Ext.chart.Chart","Ext.chart.axis.Numeric","Ext.chart.axis.Category"],config:{title:T("title.chart_v_eco_radar"),cls:"grayBg",layout:"fit"},constructor:function(b){var a=this;this.callParent(arguments);this.on("painted",function(){HatioBB.setting.on("vehicle",this.refresh,this);HatioBB.setting.on("fromYear",this.refresh,this);this.refresh()});this.on("erased",function(){HatioBB.setting.un("vehicle",this.refresh,this);HatioBB.setting.un("fromYear",this.refresh,this)})},refresh:function(d,c){if(HatioBB.setting.get("vehicle")===this.vehicle&&HatioBB.setting.get("fromYear")===this.fromYear){return}var b=this;var d=Ext.getStore("VehicleRunStore");var e=new Date().getFullYear();var a=new Date().getMonth()+1;this.vehicle=HatioBB.setting.get("vehicle");this.fromYear=HatioBB.setting.get("fromYear")||(e-1);var f=d.getProxy();f.config.extraParams.vehicle=this.vehicle;f.config.extraParams.from_year=this.fromYear;f.config.extraParams.to_year=e;f.config.extraParams.from_month=1;f.config.extraParams.to_month=a;d.load(function(j){var i=this.getGroups();var l={consmpt:{name:T("label.consumption")},oos_cnt:{name:T("label.oos_count")},co2_emss:{name:T("label.co2_emission")},mnt_time:{name:T("label.maint_time")},mnt_cnt:{name:T("label.maint_count")},run_dist:{name:T("label.run_distance")},effcc:{name:T("label.fuel_efficiency")},run_time:{name:T("label.run_time")}};var h=[];Ext.Array.each(i,function(w){var s=w.name.toString();var p=w.children;var u=0;var x=0;var t=0;var r=0;var q=0;var o=0;var n=0;var m=0;var v=0;Ext.each(p,function(y){if(y.get("vehicle")){u+=1}if(y.get("consmpt")){x+=y.get("consmpt")}if(y.get("oos_cnt")){t+=y.get("oos_cnt")}if(y.get("co2_emss")){r+=y.get("co2_emss")}if(y.get("mnt_time")){q+=y.get("mnt_time")}if(y.get("mnt_cnt")){o+=y.get("mnt_cnt")}if(y.get("run_dist")){n+=y.get("run_dist")}if(y.get("effcc")){m+=y.get("effcc")}if(y.get("run_time")){v+=y.get("run_time")}});x=x/500/u;t=t/u;r=r/100/u;q=q/10/u;o=o/u;n=n/500/u;m=m/u;v=v/500/u;l.consmpt[s]=x;l.oos_cnt[s]=t;l.co2_emss[s]=r;l.mnt_time[s]=q;l.mnt_cnt[s]=o;l.run_dist[s]=n;l.effcc[s]=m;l.run_time[s]=v;h.push(s)});var k=[];for(var g in l){k.push(l[g])}if(b.chart){b.remove(b.chart)}b.chart=b.add(b.buildChart(h,k))})},buildChart:function(a,d){var b=Ext.create("Ext.data.JsonStore",{fields:Ext.Array.merge(a,["name"]),data:d});var c=Ext.Array.map(a,function(e){return{showInLegend:false,showMarkers:true,type:"radar",xField:"name",yField:e,style:{opacity:0.4},markerConfig:{radius:3,size:5}}});return{xtype:"chart",themeCls:"radar1",theme:"Demo",insetPadding:30,shadow:true,animate:true,store:b,interactions:["rotate","reset"],legend:{position:"bottom"},axes:[{type:"Radial",position:"radial",label:{display:true}}],series:c}}});Ext.define("HatioBB.controller.Report",{extend:"Ext.app.Controller",requires:["HatioBB.view.report.AreaChart","HatioBB.view.report.BarChart","HatioBB.view.report.ColumnChart","HatioBB.view.report.LineChart","HatioBB.view.report.PieChart","HatioBB.view.report.DailyReport","HatioBB.view.report.MonthlyReport","HatioBB.view.chart.vehicle.VehicleHealth"],config:{refs:{content:"content",header:"header",navReport:"nav_report"},control:{nav_report:{itemtap:"onItemTap"},"chart_v_health #xxx":{itemtap:function(a,b){Ext.Msg.alert("ItemTap",b);this.showReport("rpt_pie")}}}},onItemTap:function(b,c,d,a){this.showReport(a.get("reportId"))},showReport:function(b){var a=this.getContent().getComponent(b);if(!a){this.getContent().removeAll();a=this.getContent().add({xtype:b})}this.getContent().setActiveItem(a);this.getHeader().clearActiveStatus();return a}});Ext.define("HatioBB.view.Nav",{extend:"Ext.navigation.View",xtype:"nav",requires:["Ext.dataview.List","HatioBB.view.nav.NavMenu","HatioBB.view.nav.NavVehicle","HatioBB.view.nav.NavDriver","HatioBB.view.nav.NavFav","HatioBB.view.nav.NavComm","HatioBB.view.nav.NavNoti","HatioBB.view.nav.NavReport"],initialize:function(){var b=this;this.callParent();var a=Ext.getStore("RecentIncidentStore");a.load();var d=Ext.getStore("VehicleMapStore");d.load();function c(e){if(this.incidentInterval){clearInterval(this.incidentInterval)}if(e>0){this.incidentInterval=setInterval(function(){a.load()},e*1000)}if(this.vehicleMapInterval){clearInterval(this.vehicleMapInterval)}if(e>0){this.vehicleMapInterval=setInterval(function(){d.load()},e*1000)}}HatioBB.setting.on({refreshTerm:c});c(HatioBB.setting.get("refreshTerm"));this.sub("incidents").on({painted:function(){b.refreshIncidents(a);a.on("load",b.refreshIncidents,b)},erased:function(){a.un("load",b.refreshIncidents,b)},scope:b});this.sub("status").on({painted:function(){b.refreshStatus(d);d.on("load",b.refreshStatus,b)},erased:function(){d.un("load",b.refreshStatus,b)},scope:b});Ext.getStore("VehicleGroupStore").load(function(e){b.refreshVGroups(this)});Ext.getStore("DriverGroupStore").load(function(e){b.refreshDGroups(this)})},destroy:function(){clearInterval(this.incidentInterval);clearInterval(this.vehicleMapInterval)},refreshStatus:function(c){var b=0;var d=0;var e=0;var a=0;c.each(function(f){switch(f.get("status")){case"Running":b++;break;case"Idle":d++;break;case"Incident":e++;break;case"Maint":a++;break}});this.sub("state_running").setHtml(T("label.state_driving")+"</br><span>"+b+"</span>");this.sub("state_idle").setHtml(T("label.state_idle")+"</br><span>"+d+"</span>");this.sub("state_incident").setHtml(T("label.state_incident")+"</br><span>"+e+"</span>");this.sub("state_maint").setHtml(T("label.state_maint")+"</br><span>"+a+"</span>")},refreshIncidents:function(a){var c=this.sub("incidents");c.removeAll();var e=a.getCount()>5?5:a.getCount();for(var b=0;b<e;b++){var d=a.getAt(b);c.add({xtype:"button",incident:d,html:'<a href="#">'+d.get("vehicle_id")+", "+d.get("driver_id")+"<span>"+Ext.Date.format(d.get("datetime"),"D Y-m-d H:i:s")+"</span></a>"})}},refreshVGroups:function(b){var a=this.sub("vgroups");a.removeAll();b.each(function(c){a.add({xtype:"button",group:c,html:'<a href="#">'+c.data.desc+"<span>("+c.data.vehicles.length+")</span></a>"})})},refreshDGroups:function(b){var a=this.sub("dgroups");a.removeAll();b.each(function(c){a.add({xtype:"button",group:c,html:'<a href="#">'+c.data.desc+"<span>("+c.data.drivers.length+")</span></a>"})})},config:{items:[{xtype:"container",cls:"mainNav",layout:{type:"vbox"},items:[{xtype:"button",id:"nav_vehicle",text:"Vehicle",cls:"navBtn",iconCls:"iconVehicle"},{xtype:"button",id:"nav_driver",text:"Driver",cls:"navBtn",iconCls:"iconDriver"},{xtype:"button",id:"nav_report",text:"Report",cls:"navBtn",iconCls:"iconReport"},{xtype:"panel",itemId:"status",height:115,layout:{type:"hbox",align:"stretch"},cls:"statusPanel",items:[{xtype:"button",itemId:"state_running",flex:1,cls:"btnDriving",state:"Running"},{xtype:"button",itemId:"state_idle",flex:1,cls:"btnStop",state:"Idle"},{xtype:"button",itemId:"state_incident",flex:1,cls:"btnIncident",state:"Incident"},{xtype:"button",itemId:"state_maint",flex:1,cls:"btnMaint",state:"Maint"}]},{xtype:"carousel",direction:"horizontal",flex:1,items:[{xtype:"panel",itemId:"incidents",cls:"incidentPanel",html:T("title.incidents_alarm"),},{xtype:"panel",itemId:"vgroups",cls:"groupPanel vGroup",html:T("title.vehicle_group"),},{xtype:"panel",itemId:"dgroups",cls:"groupPanel dGroup",html:T("title.driver_group"),}]}]}]}});Ext.define("HatioBB.view.monitor.Incident",{extend:"Ext.TabPanel",requires:["HatioBB.view.chart.vehicle.Accel"],xtype:"monitor_incident",id:"monitor_incident",config:{tabBarPosition:"bottom"},constructor:function(b){b.items=[this.zInfo,this.zVideo,this.zChart];this.callParent(arguments);var a=this;this.storeHandler=function(d,c){a.refreshTrack(d,c)};a.getLogStore().on("load",this.storeHandler);a.items.items[0].on("activate",function(){a.refresh()})},destroy:function(){this.getLogStore().un("load",this.storeHandler);this.callParent(arguments)},refresh:function(){this.setIncident()},setIncident:function(i){var l=this;if(!i){if(this.incident){i=this.incident}else{i=Ext.getStore("RecentIncidentStore").first();if(!i&&!this.isHidden()){setTimeout(function(){l.setIncident()},3000);return}}}this.incident=i;this.incident.set("obd_connected_text",this.incident.get("obd_connected")?"connected":"disconnected");HatioBB.setting.set("driver",i.get("driver_id"));HatioBB.setting.set("vehicle",i.get("vehicle_id"));var h=Ext.getStore("VehicleMapStore");var f=h.findRecord("id",i.get("vehicle_id"));var e=f.get("image_clip");var g=this.sub("vehicleImage");if(e){if(HatioBB.setting.get("app_mode")){g.setSrc("/download?blob-key="+e)}else{g.setSrc(e)}}else{g.setSrc("resources/images/bgVehicle.png")}i.set("registration_number",f.get("registration_number"));var d=Ext.getStore("DriverBriefStore");var b=d.findRecord("id",i.get("driver_id"));var k=b.get("id");var c=b.get("image_clip");var m=this.sub("driverImage");if(c){if(HatioBB.setting.get("app_mode")){m.setSrc("/download?blob-key="+c)}else{m.setSrc(c)}}else{m.setSrc("resources/images/bgDriver.png")}i.set("driver_name",b.get("name"));i.set("location","Resolving ..");this.getLocation(i.get("lattitude"),i.get("longitude"),function(n){i.set("location",n);l.sub("briefInfo").setData(i.getData())});this.sub("briefInfo").setData(i.getData());this.sub("detailInfo").setData(i.getData());this.sub("confirm").setValue(i.get("confirm"));this.getLogStore().clearFilter(true);this.getLogStore().filter([{property:"incident",value:i.get("key")}]);this.getLogStore().load();var a="";var j=i.get("video_clip");if(j!=null&&j.length>1){if(j.indexOf("http")==0){a=j}else{a="/download?blob-key="+j}}this.sub("video").updateUrl([a])},getIncident:function(){return this.incident},getLogStore:function(){if(!this.logStore){this.logStore=Ext.getStore("IncidentLogStore")}return this.logStore},getMap:function(){if(!this.map){this.map=this.getAt(0).down("#map").getMap()}return this.map},getTrackLine:function(){return this.trackline},setTrackLine:function(a){if(this.trackline){this.trackline.setMap(null)}this.trackline=a},getMarker:function(){return this.marker},setMarker:function(a){if(this.marker){this.marker.setMap(null)}this.marker=a},setMarkers:function(a){if(this.markers){Ext.each(this.markers,function(b){b.setMap(null)})}this.markers=a},resetMarkers:function(){if(this.markers){Ext.each(this.markers,function(a){a.setMap(null)})}this.markers=null},refreshTrack:function(h,d){this.setTrackLine(new google.maps.Polyline({map:this.getMap(),strokeColor:"#FF0000",strokeOpacity:1,strokeWeight:4}));var j=this.getTrackLine().getPath();var a;var c;Ext.Array.each(d,function(k){c=new google.maps.LatLng(k.get("lattitude"),k.get("longitude"));j.push(c);if(!a){a=new google.maps.LatLngBounds(c,c)}else{a.extend(c)}});if(!a){return}if(a.isEmpty()||a.getNorthEast().equals(a.getSouthWest())){this.getMap().setCenter(a.getNorthEast())}else{this.getMap().fitBounds(a)}var f=j.getAt(0);if(f){var b=new google.maps.Marker({position:new google.maps.LatLng(f.lat(),f.lng()),icon:"resources/images/iconStartPoint.png",map:this.getMap()});var i=j.getAt(j.getLength()-1);var e=new google.maps.Marker({position:new google.maps.LatLng(i.lat(),i.lng()),map:this.getMap()});this.setMarkers([b,e])}var g=new google.maps.LatLng(this.getIncident().get("lattitude"),this.getIncident().get("longitude"));this.setMarker(new google.maps.Marker({position:g,icon:new google.maps.MarkerImage("resources/images/iconIncidentPoint.png",null,null,new google.maps.Point(60,80)),map:this.getMap(),title:"incidentPoint"}))},refreshChart:function(b,a){this.down("#chart").refresh()},getLocation:function(d,a,c){if(d!==undefined&&a!==undefined){var b=new google.maps.LatLng(d,a);geocoder=new google.maps.Geocoder();geocoder.geocode({latLng:b},function(f,e){if(e==google.maps.GeocoderStatus.OK){if(f[0]){c(f[0].formatted_address)}}else{console.log("Geocoder failed due to: "+e)}})}},zInfo:{xtype:"panel",itemId:"info",title:"개요",iconCls:"iconsTab tabMap",cls:"grayBg",layout:{type:"vbox",align:"stretch"},items:[{xtype:"panel",itemId:"brief",layout:"hbox",cls:"marginT10 marginL10",height:125,items:[{xtype:"image",itemId:"driverImage",cls:"imgDriver"},{xtype:"image",itemId:"vehicleImage",cls:"imgVehicle"},{xtype:"panel",itemId:"briefInfo",flex:1,data:{driver_name:"",vehicle_name:"",location:"",datetime:""},tpl:['<div class="infoID">{driver_id}({driver_name}) , {vehicle_id}({registration_number})</div>','<div class="infoText">Location : {location}</div>','<div class="infoText">Time : {datetime} </div>']}]},{xtype:"panel",height:45,cls:"shotHList",layout:{type:"hbox",align:"stretch"},items:[{xtype:"togglefield",itemId:"confirm",name:"confirm"},{xtype:"container",itemId:"detailInfo",flex:1,cls:"divHAlign",data:{impulse_abs:"",engine_temp:""},tpl:['<div class="iconImplus">Impulse <span>{impulse_abs}({impulse_x},{impulse_y},{impulse_z})/{impulse_threshold}</span></div>','<div class="iconETemp">Engine Temp <span>{engine_temp}/{engine_temp_threshold}</span></div>','<div class="iconVelocity">Velocity <span>{velocity}</span></div>','<div class="iconOBD">OBD Connected <span>{obd_connected_text}</span></div>']}]},{xtype:"map",itemId:"map",flex:1,useCurrentLocation:false,mapOptions:{zoom:10,maxZoom:19,minZoom:3,center:null,mapTypeId:google.maps.MapTypeId.ROADMAP}}]},zVideo:{xtype:"panel",title:"Movie",layout:"fit",iconCls:"iconsTab tabMovie",items:[{xtype:"video",itemId:"video",posterUrl:"porsche.png"}]},zChart:{xtype:"chart_v_accel",title:"Chart",layout:"fit",iconCls:"iconsTab tabChart",}});Ext.define("HatioBB.view.Main",{extend:"Ext.Container",xtype:"main",requires:["Ext.navigation.View","Ext.navigation.Bar","HatioBB.view.Nav","HatioBB.view.Content","HatioBB.view.Header","HatioBB.view.monitor.Map","HatioBB.view.monitor.Info","HatioBB.view.monitor.Incident"],constructor:function(b){b=b||{};b.items=this.buildItems();this.callParent([b]);var a=this;HatioBB.setting.on("dockPosition",function(c){Ext.getCmp("nav").setDocked(HatioBB.setting.get("dockPosition")).show()})},buildItems:function(){return[{id:"nav",cls:"nav",xtype:"nav",docked:HatioBB.setting.get("dockPosition"),width:255},{id:"content",xtype:"content"}]},config:{fullscreen:true,layout:{type:"card"}}});Ext.define("HatioBB.view.driver.Driver",{extend:"Ext.tab.Panel",requires:["HatioBB.view.driver.Summary","HatioBB.view.chart.driver.Running","HatioBB.view.chart.driver.EcoRadar"],xtype:"driver",id:"driver",config:{tabBarPosition:"bottom",items:[{xtype:"driver_summary",iconCls:"iconsTab tabSummary",title:"Summary"},{xtype:"chart_d_running",iconCls:"iconsTab tabDrive",title:"Running"},{xtype:"chart_d_eco_radar",iconCls:"iconsTab tabEco",title:"Eco-Driving"}]},buildSettings:function(){return[{xtype:"selectfield",label:T("label.fromYear"),name:"fromYear",valueField:"year",displayField:"year",value:HatioBB.setting.get("fromYear"),listeners:{change:function(b,a){HatioBB.setting.set("fromYear",a)}},store:"YearStore"}]}});Ext.define("HatioBB.view.vehicle.Vehicle",{extend:"Ext.tab.Panel",requires:["HatioBB.view.vehicle.Summary","HatioBB.view.chart.vehicle.Running","HatioBB.view.chart.vehicle.Consumable","HatioBB.view.vehicle.Repair","HatioBB.view.chart.vehicle.EcoRadar"],xtype:"vehicle",id:"vehicle",config:{tabBarPosition:"bottom",items:[{xtype:"vehicle_summary",iconCls:"iconsTab tabSummary",title:"Summary"},{xtype:"chart_v_running",iconCls:"iconsTab tabDrive",title:"Running"},{xtype:"chart_v_consumable",iconCls:"iconsTab tabConsumable",title:"Consumable"},{xtype:"vehicle_repair",iconCls:"iconsTab tabRepair",title:"Repair"},{xtype:"chart_v_eco_radar",iconCls:"iconsTab tabEco",title:"Eco-Driving"}]},buildSettings:function(){return[{xtype:"selectfield",label:T("label.fromYear"),name:"fromYear",valueField:"year",displayField:"year",value:HatioBB.setting.get("fromYear"),listeners:{change:function(b,a){HatioBB.setting.set("fromYear",a)}},store:"YearStore"}]}});Ext.define("HatioBB.controller.Main",{extend:"Ext.app.Controller",requires:["HatioBB.view.Setting","HatioBB.view.driver.Driver","HatioBB.view.vehicle.Vehicle"],config:{routes:{map:"onMap",info:"onInfo",incident:"onIncident"},refs:{main:"main",nav:"nav",content:"content",header:"header"},control:{"#ext-viewport":{orientationchange:"onOC"},"#content":{painted:"onHome"},"header #map":{tap:"onMap"},"header #info":{tap:"onInfo"},"header #incident":{tap:"onIncident"},"header #collapse":{tap:"onCollapse"},"header #setting":{tap:"onSetting"},"header #refresh":{tap:"onRefresh"},"#nav_driver":{tap:"onDriver"},"#nav_vehicle":{tap:"onVehicle"},"#nav_report":{tap:"onReport"},"#nav_fav":{tap:"onFav"},"#nav_comm":{tap:"onComm"},"#nav_noti":{tap:"onNoti"},"nav #incidents button":{tap:"onIncident"},"nav #status button":{tap:"onStatus"},"nav #vgroups button":{tap:"onVGroup"},"nav #dgroups button":{tap:"onDGroup"},monitor_map:{drivertap:"onMapDriverTap",vehicletap:"onMapVehicleTap",tracktap:"onMapTrackTap"},"monitor_info #incidents button":{tap:"onIncident"},"monitor_info image":{tap:"onImage"},"monitor_incident image":{tap:"onImage"},nav_driver:{itemtap:"onDriverItemTap",disclose:"onDriverDisclose"},nav_vehicle:{itemtap:"onVehicleItemTap",disclose:"onVehicleDisclose"},vehicle_summary:{showMap:"onShowMap",showTrack:"onShowTrack"},driver_summary:{showMap:"onShowMap",showTrack:"onShowTrack"}}},onOC:function(d,b,a,c){if(b==="portrait"){this.getNav().setDocked(null).hide()}else{this.getNav().setDocked(HatioBB.setting.get("dockPosition")).show()}},onHome:function(){this.showMonitor("monitor_map")},showMonitor:function(a){var b=this.getContent().getComponent(a);if(!b){this.getContent().removeAll();b=this.getContent().add({xtype:a})}this.getContent().setActiveItem(b);this.getHeader().setActiveStatus(b.getId());return b},showVehicle:function(){var a=this.getContent().getComponent("vehicle");if(!a){this.getContent().removeAll();a=this.getContent().add({xtype:"vehicle"})}this.getContent().setActiveItem(a);this.getHeader().clearActiveStatus();return a},showDriver:function(){var a=this.getContent().getComponent("driver");if(!a){this.getContent().removeAll();a=this.getContent().add({xtype:"driver"})}this.getContent().setActiveItem(a);this.getHeader().clearActiveStatus();return a},onMap:function(b,c){var a=this.showMonitor("monitor_map")},onInfo:function(b,c){var a=this.showMonitor("monitor_info")},onMapTrackTap:function(b){var a=this.showMonitor("monitor_info");HatioBB.setting.set("monitoring_vehicle",b.get("id"));HatioBB.setting.set("vehicle",b.get("id"));HatioBB.setting.set("driver",b.get("driver_id"))},onMapDriverTap:function(a){HatioBB.setting.set("driver",a.get("id"));this.showDriver()},onMapVehicleTap:function(a){HatioBB.setting.set("vehicle",a.get("id"));this.showVehicle()},onIncident:function(b,c){var a=this.showMonitor("monitor_incident");if(b&&b.config&&b.config.incident){a.setIncident(b.config.incident)}else{a.setIncident()}},onSetting:function(a,b){Ext.create("HatioBB.view.Setting",{}).showBy(a)},onRefresh:function(a,c){var b=this.getContent().getActiveItem();if(typeof(b.refresh)==="function"){b.refresh()}},onCollapse:function(a,b){if(this.getNav().getDocked()){this.getNav().setDocked(null).hide()}else{this.getNav().setDocked(HatioBB.setting.get("dockPosition")).show()}},onDriver:function(a,b){this.getNav().setNavigationBar(true);this.getNav().push({xtype:"nav_driver"})},onVehicle:function(a,b){this.getNav().setNavigationBar(true);this.getNav().push({xtype:"nav_vehicle"})},onReport:function(a,b){this.getNav().setNavigationBar(true);this.getNav().push({xtype:"nav_report"})},onStatus:function(c,d){var b=Ext.getStore("VehicleFilteredStore");var a=this.getNav().down("#status");a._filtered=!a._filtered;if(a._filtered){b.clearFilter(true);b.filter("status",c.config.state)}else{b.clearFilter()}this.showMonitor("monitor_map")},onVGroup:function(d,g){var c=d.config.group.get("id");var f=Ext.getStore("VehicleGroupStore").findRecord("id",c);var b=f?f.get("vehicles"):[];var a=Ext.getStore("VehicleFilteredStore");a.clearFilter(true);a.filterBy(function(e){return Ext.Array.indexOf(b,e.get("id"))>=0});this.showMonitor("monitor_map")},onDGroup:function(d,g){var c=d.config.group.get("id");var f=Ext.getStore("DriverGroupStore").findRecord("id",c);var a=f?f.get("drivers"):[];var b=Ext.getStore("VehicleFilteredStore");b.clearFilter(true);b.filterBy(function(e){return Ext.Array.indexOf(a,e.get("driver_id"))>=0});this.showMonitor("monitor_map")},onFav:function(a,b){this.getNav().setNavigationBar(true);this.getNav().push({xtype:"nav_fav"})},onComm:function(a,b){this.getNav().setNavigationBar(true);this.getNav().push({xtype:"nav_comm"})},onNoti:function(a,b){this.getNav().setNavigationBar(true);this.getNav().push({xtype:"nav_noti"})},onImage:function(a){if(a.config.itemId==="driverImage"){this.showDriver()}else{this.showVehicle()}},onDriverItemTap:function(b,c,d,a){HatioBB.setting.set("driver",a.get("id"))},onDriverDisclose:function(d,a,c,b,f){d.select(b);this.showDriver();HatioBB.setting.set("driver",a.get("id"))},onVehicleItemTap:function(b,c,d,a){HatioBB.setting.set("vehicle",a.get("id"))},onVehicleDisclose:function(d,a,c,b,f){d.select(b);this.showVehicle();HatioBB.setting.set("vehicle",a.get("id"))},onShowMap:function(b){var a=this.showMonitor("monitor_map");HatioBB.setting.set("vehicle",b)},onShowTrack:function(b){var a=this.showMonitor("monitor_info");HatioBB.setting.set("vehicle",b)}});Ext.define("HatioBB",{singleton:true,mixins:{user:"HatioBB.mixin.User",subitem:"HatioBB.mixin.SubItem",setting:"HatioBB.mixin.Setting"}});Ext.application({controllers:["Main"],name:"HatioBB",requires:["Ext.MessageBox","Ext.tab.Panel"],controllers:["Main","Report"],views:["Main","Setting"],stores:["VehicleFilteredStore","VehicleStore","RecentIncidentStore","VehicleMapStore","DriverStore","DriverBriefStore","VehicleGroupStore","DriverGroupStore","TrackByVehicleStore","IncidentByVehicleStore","IncidentLogStore","DashboardVehicleStore","VehicleConsumableStore","DriverRunStore","VehicleRunStore","YearStore","DashboardConsumableStore"],icon:{57:"resources/icons/Icon.png",72:"resources/icons/Icon~ipad.png",114:"resources/icons/Icon@2x.png",144:"resources/icons/Icon~ipad@2x.png"},phoneStartupScreen:"resources/loading/Homescreen.jpg",tabletStartupScreen:"resources/loading/Homescreen~ipad.jpg",launch:function(){Ext.fly("appLoadingIndicator").destroy();HatioBB.setting.set("app_mode",(0===window.location.pathname.indexOf("/m/")));HatioBB.setting.set("version","0.5.6");Ext.Viewport.add(Ext.create("HatioBB.view.Main"))},onUpdated:function(){Ext.Msg.confirm("Application Update","This application has just successfully been updated to the latest version. Reload now?",function(){window.location.reload()})}});